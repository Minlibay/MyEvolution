<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{SEO_TITLE}}</title>
  <meta name="description" content="{{SEO_DESCRIPTION}}" />
  <meta name="keywords" content="{{SEO_KEYWORDS}}" />
  <meta property="og:title" content="{{SEO_TITLE}}" />
  <meta property="og:description" content="{{SEO_DESCRIPTION}}" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="{{SEO_OG_IMAGE}}" />
  <link rel="icon" href="{{FAVICON_URL}}" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .kv { display:flex; gap:10px; font-size:12px; color:var(--text-secondary); }
    .kv b { color:var(--text-primary); }
    .muted { color:var(--text-muted); }
    #worldPanel { display:flex; flex-direction:column; overflow:hidden; min-height:0; }
    #canvasWrap { flex:1; position:relative; overflow:hidden; min-height:0; }
    #canvasWrap canvas { background:#070a14; display:block; width:100%; height:100%; }
    #agentTooltip { position:absolute; left:0; top:0; display:none; pointer-events:none; z-index:40; background:rgba(10,14,26,0.95); backdrop-filter:blur(8px); border:1px solid var(--border-default); border-radius:var(--radius-sm); padding:8px 10px; min-width:140px; max-width:260px; font-size:12px; color:var(--text-primary); box-shadow:var(--shadow-md); }
    #agentTooltip .title { font-weight:700; margin-bottom:6px; color:var(--text-accent); }
    #agentTooltip .muted { color:var(--text-secondary); }
    #agentTooltip .mono { font-family:var(--font-mono); }
    #camPad { position:absolute; right:16px; bottom:16px; z-index:12; display:flex; flex-direction:column; gap:4px; pointer-events:auto; }
    .camBtn { width:36px; height:36px; border-radius:var(--radius-sm); border:1px solid var(--border-default); background:rgba(10,14,26,0.85); backdrop-filter:blur(8px); color:var(--text-secondary); display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; font-size:15px; transition:all var(--transition-fast); padding:0; }
    .camBtn:hover { background:var(--bg-glass-hover); color:var(--text-primary); border-color:var(--border-hover); }
    .camBtn:active { transform:translateY(1px); }
    .camBtn:disabled { opacity:0.4; cursor:not-allowed; }
    #chatSection { display:flex; flex-direction:column; flex:1; min-height:0; }
    #chatBox { display:flex; flex-direction:column; flex:1; min-height:0; }
    #chatMessages { flex:1; min-height:0; overflow-y:auto; padding:8px; border:1px solid var(--border-subtle); border-radius:var(--radius-sm); background:rgba(0,0,0,0.18); }
    #chatAnnounce { display:none; margin-bottom:8px; padding:8px 10px; border-radius:var(--radius-sm); border:1px solid rgba(251,191,36,0.15); background:var(--warning-bg); color:var(--warning); font-size:12px; line-height:1.35; }
    #chatAnnounce b { color:var(--warning); }
    #events { flex:1; min-height:0; overflow-y:auto; font-family:var(--font-mono); font-size:12px; }
    .event { padding:6px 10px; border-bottom:1px solid var(--border-subtle); color:var(--text-secondary); }
    #bannerSlot { display:flex; align-items:center; justify-content:center; padding:6px 0; background:rgba(0,0,0,0.15); border-bottom:1px solid var(--border-subtle); }
    #bannerSlot:empty { display:none; }
    #bannerContainer { width:728px; height:90px; border-radius:var(--radius-sm); border:1px dashed rgba(255,255,255,0.10); display:flex; align-items:center; justify-content:center; overflow:hidden; color:var(--text-muted); font-size:12px; flex-shrink:0; }
    @media(max-width:780px){ #bannerSlot{display:none;} }
    #cookieBar { position:fixed; left:0; right:0; bottom:0; z-index:60; padding:12px 20px; display:none; gap:16px; align-items:center; justify-content:space-between; }
    #cookieText { font-size:12px; color:var(--text-secondary); line-height:1.35; max-width:980px; }
    #cookieText b { color:var(--text-primary); }
    #cookieText a { color:var(--text-accent); text-decoration:underline; }
    button { font-family:inherit; }
    .panel-head { display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border-subtle); }
    .panel-head h3 { margin:0; font-size:0.85rem; font-weight:600; color:var(--text-accent); }
  </style>
</head>
<body>
<div class="app-layout">

  <!-- ===== NAVBAR ===== -->
  <nav class="navbar" style="flex-shrink:0;">
    <div class="navbar-brand">
      <svg width="28" height="28" viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="46" stroke="#818cf8" stroke-width="6"/><circle cx="35" cy="40" r="8" fill="#818cf8"/><circle cx="65" cy="40" r="8" fill="#6366f1"/><path d="M30 65 Q50 82 70 65" stroke="#818cf8" stroke-width="5" fill="none" stroke-linecap="round"/></svg>
      <span>{{PROJECT_NAME}}</span>
    </div>
    <div class="navbar-right">
      <div class="navbar-status">
        <span class="status-dot" id="statusDot"></span>
        <span id="onlineCount">0</span> –æ–Ω–ª–∞–π–Ω
      </div>
    </div>
  </nav>

  <!-- ===== BANNER ===== -->
  <div id="bannerSlot" style="flex-shrink:0;"><div id="bannerContainer">{{BANNER_HTML}}</div></div>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="main-content">

    <!-- Simulation Panel -->
    <div class="sim-panel" id="worldPanel">
      <div class="sim-info-bar" id="simInfoBar">
        <div class="info-item">–¢–∏–∫: <span class="info-value" id="infoTick">0</span></div>
        <div class="info-item">–î–µ–Ω—å: <span class="info-value" id="infoDay">0</span></div>
        <div class="info-item">–í—Ä–µ–º—è: <span class="info-value" id="infoTime">00:00</span></div>
        <div class="info-item">–°–µ–∑–æ–Ω: <span class="info-value" id="infoSeason">‚Äî</span></div>
        <div class="info-item">–ê–≥–µ–Ω—Ç—ã: <span class="info-value" id="infoAgents">0</span></div>
        <div class="info-item">Run: <span class="info-value" id="infoRun">#1</span></div>
        <div id="worldControls" style="display:none; margin-left:auto;">
          <button id="btnCreateAgent" class="btn btn-primary btn-sm">+ –°–æ–∑–¥–∞—Ç—å –∞–≥–µ–Ω—Ç–∞</button>
          <span id="createAgentState" class="text-sm text-muted" style="margin-left:6px;"></span>
        </div>
      </div>
      <div class="kv" id="status" style="padding:4px 16px; background:rgba(0,0,0,0.25); border-bottom:1px solid var(--border-subtle); flex-wrap:wrap;"></div>

      <div id="canvasWrap">
        <canvas id="cv" width="1000" height="720"></canvas>
        <div id="agentTooltip"></div>
        <div id="camPad">
          <button id="camZoomIn" class="camBtn" title="–ø—Ä–∏–±–ª–∏–∑–∏—Ç—å" type="button">+</button>
          <button id="camUp" class="camBtn" title="–≤–≤–µ—Ä—Ö" type="button">‚Üë</button>
          <button id="camZoomOut" class="camBtn" title="–æ—Ç–¥–∞–ª–∏—Ç—å" type="button">‚àí</button>
          <button id="camLeft" class="camBtn" title="–≤–ª–µ–≤–æ" type="button">‚Üê</button>
          <button id="camReset" class="camBtn" title="—Å–±—Ä–æ—Å (R)" type="button">R</button>
          <button id="camRight" class="camBtn" title="–≤–ø—Ä–∞–≤–æ" type="button">‚Üí</button>
          <button id="camDown" class="camBtn" title="–≤–Ω–∏–∑" type="button">‚Üì</button>
        </div>
      </div>
    </div>

    <!-- ===== SIDEBAR ===== -->
    <div class="sidebar">
      <div class="sidebar-tabs">
        <div class="sidebar-tab active" data-tab="tab-chat">–ß–∞—Ç</div>
        <div class="sidebar-tab" data-tab="tab-events">–°–æ–±—ã—Ç–∏—è</div>
        <div class="sidebar-tab" data-tab="tab-news">–ù–æ–≤–æ—Å—Ç–∏</div>
        <div class="sidebar-tab" data-tab="tab-agent">–ê–≥–µ–Ω—Ç</div>
        <div class="sidebar-tab" data-tab="tab-history">–ò—Å—Ç–æ—Ä–∏—è</div>
      </div>

      <!-- TAB: Chat -->
      <div class="sidebar-panel active" id="tab-chat">
        <div id="chatSection">
          <div id="chatAuth" class="auth-section">
            <div class="form-row">
              <div class="form-group">
                <label>–õ–æ–≥–∏–Ω</label>
                <input id="authUser" type="text" placeholder="username" />
              </div>
              <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input id="authPass" type="password" placeholder="password" />
              </div>
            </div>
            <div class="row" style="gap:6px;">
              <button id="btnLogin" class="btn btn-primary btn-sm">–í–æ–π—Ç–∏</button>
              <button id="btnRegister" class="btn btn-secondary btn-sm">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
              <button id="btnLogout" class="btn btn-secondary btn-sm" style="display:none;">–í—ã–π—Ç–∏</button>
              <span id="authState" class="text-sm text-muted"></span>
            </div>
          </div>

          <div id="accountBar" style="display:none;" class="auth-logged-in">
            <div class="auth-user-info">
              <div class="auth-avatar" id="accountAvatar">?</div>
              <div>
                <div id="accountText" class="text-sm" style="font-weight:600;"></div>
                <a id="adminLink" href="/adminkins" style="display:none;" class="text-xs text-accent">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a>
              </div>
            </div>
            <button id="btnLogout2" class="btn btn-secondary btn-xs">–í—ã–π—Ç–∏</button>
          </div>

          <div id="chatBox" style="display:none;">
            <div id="chatAnnounce"><b>–ê–Ω–æ–Ω—Å:</b> <span id="chatAnnounceText"></span></div>
            <div id="chatMessages"></div>
            <div class="chat-input-row" style="margin-top:8px;">
              <input id="chatInput" type="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
              <button id="btnSend" class="btn btn-primary btn-sm" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: Events -->
      <div class="sidebar-panel" id="tab-events">
        <div class="panel-head">
          <h3>–°–æ–±—ã—Ç–∏—è</h3>
        </div>
        <div id="events"></div>
      </div>

      <!-- TAB: News -->
      <div class="sidebar-panel" id="tab-news">
        <div id="newsAdmin" style="display:none; margin-bottom:12px;">
          <div class="card">
            <div class="card-title" style="margin-bottom:8px;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å</div>
            <div class="form-group" style="margin-bottom:6px;">
              <input id="newsTitle" type="text" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" />
            </div>
            <div class="form-group" style="margin-bottom:6px;">
              <textarea id="newsText" placeholder="–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏" rows="3"></textarea>
            </div>
            <div class="row">
              <button id="btnPostNews" class="btn btn-primary btn-sm">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
              <span id="newsAdminState" class="text-sm text-muted"></span>
            </div>
          </div>
        </div>
        <div id="newsList"></div>
      </div>

      <!-- TAB: My Agent -->
      <div class="sidebar-panel" id="tab-agent">
        <div id="myAgent">
          <div id="myAgentState" class="text-sm text-muted" style="padding:20px 0; text-align:center;">–í–æ–π–¥–∏—Ç–µ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∞–≥–µ–Ω—Ç–∞, —á—Ç–æ–±—ã —Å–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–∏–º.</div>
          <div id="myAgentBody" style="display:none;">
            <div class="card">
              <div style="font-weight:700; margin-bottom:6px; font-size:1rem;" id="myAgentName"></div>
              <div class="text-xs text-muted" id="myAgentOwner" style="margin-bottom:10px;"></div>
              <div class="divider"></div>
              <div class="text-xs text-muted" style="margin-top:8px;">–°—Ç–∞—Ç—É—Å</div>
              <div id="myAgentStatus" style="margin-bottom:8px; font-size:13px;"></div>
              <div class="text-xs text-muted">–ù—É–∂–¥—ã</div>
              <div id="myAgentNeeds" style="font-size:13px; margin-bottom:8px;"></div>
              <div class="text-xs text-muted">–í–æ–∑—Ä–∞—Å—Ç / –∑–¥–æ—Ä–æ–≤—å–µ / —ç–Ω–µ—Ä–≥–∏—è</div>
              <div id="myAgentVitals" style="font-size:13px;"></div>
              <div id="myAgentExtra"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: History -->
      <div class="sidebar-panel" id="tab-history">
        <div class="panel-head">
          <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤</h3>
        </div>
        <div id="history" style="font-family:var(--font-mono); font-size:12px; flex:1; min-height:0; overflow-y:auto;"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== AGENT CREATION MODAL ===== -->
<div id="agentModal" class="modal-overlay">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;">
      <div>
        <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –∞–≥–µ–Ω—Ç–∞</div>
        <div class="text-sm text-muted">–ê–≥–µ–Ω—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ –º–∏—Ä–µ –∏ –±—É–¥–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ</div>
      </div>
      <button id="btnCloseAgentModal" class="btn btn-secondary btn-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="form-group" style="margin-bottom:12px;">
      <label>–ò–º—è</label>
      <input id="agentName" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ö–∏–Ω" />
    </div>

    <div class="form-group" style="margin-bottom:12px;">
      <label>–ü–æ–ª</label>
      <div class="radio-group">
        <label class="radio-label"><input type="radio" name="agentSex" value="male" checked /> –º—É–∂—Å–∫–æ–π</label>
        <label class="radio-label"><input type="radio" name="agentSex" value="female" /> –∂–µ–Ω—Å–∫–∏–π</label>
      </div>
    </div>

    <div class="form-group" style="margin-bottom:12px;">
      <label>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (5 –æ—á–∫–æ–≤)</label>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px;">
        <div class="form-group">
          <label class="text-xs">–°–∏–ª–∞</label>
          <input id="agentStatsStrength" type="number" min="0" max="3" value="0" />
        </div>
        <div class="form-group">
          <label class="text-xs">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</label>
          <input id="agentStatsIntelligence" type="number" min="0" max="3" value="0" />
        </div>
        <div class="form-group">
          <label class="text-xs">–°–æ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</label>
          <input id="agentStatsSocial" type="number" min="0" max="3" value="0" />
        </div>
        <div class="form-group">
          <label class="text-xs">–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å</label>
          <input id="agentStatsEndurance" type="number" min="0" max="3" value="0" />
        </div>
      </div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <div id="agentStatsLeft" class="text-sm text-muted"></div>
      <div class="preset-group">
        <button id="btnPresetInventor" class="preset-btn">–ò–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å</button>
        <button id="btnPresetSurvivor" class="preset-btn">–í—ã–∂–∏–≤–∞–ª—å—â–∏–∫</button>
        <button id="btnPresetLeader" class="preset-btn">–í–æ–∂–¥—å</button>
      </div>
    </div>

    <div class="modal-actions">
      <span id="agentModalState" class="text-sm text-muted"></span>
      <button id="btnSubmitAgent" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- ===== WELCOME MODAL ===== -->
<div id="welcomeModal" class="modal-overlay">
  <div class="modal" style="max-width:600px;">
    <div class="modal-title">–û –ø—Ä–æ–µ–∫—Ç–µ</div>
    <div class="text-sm text-muted" style="margin-bottom:12px;">–ö–æ—Ä–æ—Ç–∫–æ: —ç—Ç–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è —Å–∏–º—É–ª—è—Ü–∏—è —ç–≤–æ–ª—é—Ü–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤ –∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</div>
    <div style="font-size:13px; color:var(--text-secondary); line-height:1.5;">
      <p style="margin-bottom:10px;">
        –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –∂–∏–∑–Ω—å—é –∞–≥–µ–Ω—Ç–æ–≤ –≤ 2D-–º–∏—Ä–µ: –æ–Ω–∏ –ø–µ—Ä–µ–º–µ—â–∞—é—Ç—Å—è, —Å–æ–±–∏—Ä–∞—é—Ç —Ä–µ—Å—É—Ä—Å—ã, –æ–±—â–∞—é—Ç—Å—è, –ø—ã—Ç–∞—é—Ç—Å—è –≤—ã–∂–∏—Ç—å, –∞ —Ç–∞–∫–∂–µ –º–æ–≥—É—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.
      </p>
      <p style="margin-bottom:10px;">
        –ï—Å–ª–∏ —Ç—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—à—å—Å—è –∏ –≤–æ–π–¥—ë—à—å, —Ç—ã —Å–º–æ–∂–µ—à—å <b style="color:var(--text-primary);">—Å–æ–∑–¥–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞</b> ‚Äî –æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –≤ –º–∏—Ä–µ, –∏ —Ç—ã —Å–º–æ–∂–µ—à—å —Å–ª–µ–¥–∏—Ç—å –∑–∞ –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º, –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –∏ —Å—É–¥—å–±–æ–π.
      </p>
    </div>
    <div class="modal-actions">
      <button id="btnCloseWelcome" class="btn btn-secondary btn-sm" style="display:none;">_</button>
      <button id="btnWelcomeOk" class="btn btn-primary">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  </div>
</div>

<!-- ===== COOKIE BAR ===== -->
<div id="cookieBar" class="cookie-bar">
  <div id="cookieText">
    <b>–§–∞–π–ª—ã cookie</b>. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º cookie –∏ –ø–æ—Ö–æ–∂–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏/—Å–µ—Å—Å–∏–∏, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
    Cookie –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ–π—Å—Ç–≤–∏—è—Ö –Ω–∞ —Å–∞–π—Ç–µ. –ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–∏–Ω—è—Ç—å¬ª –∏ –ø—Ä–æ–¥–æ–ª–∂–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–∞–π—Ç–æ–º, —Ç—ã –¥–∞—ë—à—å —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç–∞–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —É—Å—Ç–∞–Ω–æ–≤–∫—É cookie.
    –°–æ–≥–ª–∞—Å–∏–µ –º–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å, —É–¥–∞–ª–∏–≤ cookie –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏/–∏–ª–∏ –∑–∞–ø—Ä–µ—Ç–∏–≤ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ (–ø—Ä–∏ —ç—Ç–æ–º —á–∞—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ).
    –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–µ—Ç–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤/–∞–Ω–∞–ª–∏—Ç–∏–∫–∏), –æ–Ω–∏ –º–æ–≥—É—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–≤–æ–∏ cookie —Å–æ–≥–ª–∞—Å–Ω–æ —Å–≤–æ–∏–º –ø–æ–ª–∏—Ç–∏–∫–∞–º. –ü–æ–¥—Ä–æ–±–Ω–µ–µ: <a href="/privacy" target="_blank" rel="noopener noreferrer">–ü–æ–ª–∏—Ç–∏–∫–∞ cookie/–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>.
  </div>
  <div style="flex-shrink:0;">
    <button id="btnCookieAccept" class="btn btn-primary btn-sm">–ü—Ä–∏–Ω—è—Ç—å</button>
  </div>
</div>

<script>
  // --- Sidebar tab switching ---
  document.querySelectorAll('.sidebar-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      const target = document.getElementById(tab.dataset.tab);
      if (target) target.classList.add('active');
    });
  });

  // --- Info bar elements ---
  const infoTick = document.getElementById('infoTick');
  const infoDay = document.getElementById('infoDay');
  const infoTime = document.getElementById('infoTime');
  const infoSeason = document.getElementById('infoSeason');
  const infoAgents = document.getElementById('infoAgents');
  const infoRun = document.getElementById('infoRun');
  const onlineCountEl = document.getElementById('onlineCount');
  const statusDot = document.getElementById('statusDot');
  const accountAvatar = document.getElementById('accountAvatar');

  const seasonNames = ['–í–µ—Å–Ω–∞', '–õ–µ—Ç–æ', '–û—Å–µ–Ω—å', '–ó–∏–º–∞'];

  function updateInfoBar(snap) {
    if (!snap || !snap.world) return;
    try {
      if (infoTick) infoTick.textContent = snap.timestep || 0;
      if (infoDay) infoDay.textContent = snap.world.day || 0;
      if (infoTime) infoTime.textContent = String(snap.world.hour || 0).padStart(2,'0') + ':' + String(snap.world.minute || 0).padStart(2,'0');
      if (infoSeason) infoSeason.textContent = seasonNames[snap.world.season] || '‚Äî';
      if (infoAgents) infoAgents.textContent = (snap.agents || []).length;
      if (infoRun) infoRun.textContent = '#' + (snap.run_number || snap.run_info?.number || 1);
      if (onlineCountEl && snap.online) onlineCountEl.textContent = snap.online.viewers || 0;
    } catch(e) {}
  }

  const status = document.getElementById('status');

  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  const agentTooltip = document.getElementById('agentTooltip');

  const welcomeModal = document.getElementById('welcomeModal');
  const btnCloseWelcome = document.getElementById('btnCloseWelcome');
  const btnWelcomeOk = document.getElementById('btnWelcomeOk');

  const cookieBar = document.getElementById('cookieBar');
  const btnCookieAccept = document.getElementById('btnCookieAccept');

  const sprites = {
    male: new Image(),
    female: new Image(),
  };

  sprites.male.src = '/static/sprites/male.png';
  sprites.female.src = '/static/sprites/female.png';

  const agentRenderState = new Map();

  let worldMapCache = {
    w: null,
    h: null,
    water: [],
    off: null,
  };

  let worldMapLoading = false;

  async function loadWorldMap() {
    if (worldMapLoading) return;
    worldMapLoading = true;
    try {
      const res = await fetch('/api/map', { cache: 'no-store' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) return;
      const m = data.map || null;
      if (!m) return;
      const w = parseInt(m.width || 0, 10);
      const h = parseInt(m.height || 0, 10);
      const water = (m.terrain && Array.isArray(m.terrain.water)) ? m.terrain.water : [];
      worldMapCache = { w, h, water, off: null };
    } catch (e) {}
    finally { worldMapLoading = false; }
  }

  function buildWaterOffscreen(w, h, water) {
    try {
      const off = document.createElement('canvas');
      off.width = Math.max(1, w);
      off.height = Math.max(1, h);
      const octx = off.getContext('2d');
      octx.clearRect(0, 0, off.width, off.height);
      octx.fillStyle = 'rgba(46, 107, 255, 0.35)';
      for (const c of (water || [])) {
        try {
          const x = c[0] | 0;
          const y = c[1] | 0;
          if (x >= 0 && y >= 0 && x < w && y < h) octx.fillRect(x, y, 1, 1);
        } catch (e) {}
      }
      return off;
    } catch (e) {
      return null;
    }
  }

  // Camera (pan/zoom)
  const camera = { x: 0, y: 0, zoom: 1, _initialized: true };
  const cameraLimits = { minZoom: 0.75, maxZoom: 6 };
  let dragging = false;
  let dragStart = null;
  let autoCenteredOnce = false;

  function computeCameraLimits(snapshot) {
    if (!snapshot) return;
    // Let's enforce strict zoom limits.
    cameraLimits.minZoom = 0.5;
    cameraLimits.maxZoom = 15;
  }

  function clampCamera(snapshot) {
    if (!snapshot) return;
    computeCameraLimits(snapshot);

    camera.zoom = Math.max(cameraLimits.minZoom, Math.min(cameraLimits.maxZoom, camera.zoom));

    const worldW = cv.width * camera.zoom;
    const worldH = cv.height * camera.zoom;

    // Allow panning, but don't let the map completely leave the screen.
    // Let's keep at least 100px of the map visible.
    const padding = 100;
    const minX = cv.width - worldW - padding;
    const maxX = padding;
    const minY = cv.height - worldH - padding;
    const maxY = padding;

    if (worldW < cv.width) {
      camera.x = (cv.width - worldW) / 2;
    } else {
      camera.x = Math.max(minX, Math.min(maxX, camera.x));
    }

    if (worldH < cv.height) {
      camera.y = (cv.height - worldH) / 2;
    } else {
      camera.y = Math.max(minY, Math.min(maxY, camera.y));
    }
  }

  function centerOnAgents(snapshot) {
    if (!snapshot || !snapshot.agents || snapshot.agents.length === 0) return;
    const w = snapshot.world.width;
    const h = snapshot.world.height;
    const sx = cv.width / w;
    const sy = cv.height / h;

    let ax = 0;
    let ay = 0;
    for (const a of snapshot.agents) {
      ax += a.x;
      ay += a.y;
    }
    ax /= snapshot.agents.length;
    ay /= snapshot.agents.length;

    const px = ax * sx;
    const py = ay * sy;
    camera.x = cv.width / 2 - px * camera.zoom;
    camera.y = cv.height / 2 - py * camera.zoom;
    clampCamera(snapshot);
  }

  function resetCamera(snapshot) {
    camera.zoom = 1;
    camera.x = 0;
    camera.y = 0;
    clampCamera(snapshot);
  }

  function zoomAtCanvasPoint(canvasX, canvasY, factor) {
    if (!lastSnapshot) return;
    computeCameraLimits(lastSnapshot);
    const oldZoom = camera.zoom;
    let newZoom = oldZoom * factor;
    newZoom = Math.max(cameraLimits.minZoom, Math.min(cameraLimits.maxZoom, newZoom));
    if (Math.abs(newZoom - oldZoom) < 1e-6) return;
    camera.x = canvasX - (canvasX - camera.x) * (newZoom / oldZoom);
    camera.y = canvasY - (canvasY - camera.y) * (newZoom / oldZoom);
    camera.zoom = newZoom;
    clampCamera(lastSnapshot);
  }

  function nudgeCamera(dx, dy) {
    if (!lastSnapshot) return;
    camera.x += dx;
    camera.y += dy;
    clampCamera(lastSnapshot);
  }

  function bindHold(btn, onStep) {
    if (!btn) return;
    let t = null;
    let raf = null;
    const step = () => {
      try { onStep(); } catch (e) {}
      raf = requestAnimationFrame(step);
    };
    const stop = () => {
      if (raf) cancelAnimationFrame(raf);
      raf = null;
      if (t) clearTimeout(t);
      t = null;
    };
    btn.addEventListener('mousedown', (e) => {
      e.preventDefault();
      onStep();
      t = setTimeout(() => { raf = requestAnimationFrame(step); }, 180);
    });
    window.addEventListener('mouseup', stop);
    btn.addEventListener('mouseleave', stop);
  }

  const centerX = () => cv.width / 2;
  const centerY = () => cv.height / 2;

  if (camZoomIn) {
    camZoomIn.disabled = true;
    camZoomIn.title = '–∑—É–º –æ—Ç–∫–ª—é—á–µ–Ω';
  }
  if (camZoomOut) {
    camZoomOut.disabled = true;
    camZoomOut.title = '–∑—É–º –æ—Ç–∫–ª—é—á–µ–Ω';
  }
  if (camUp) { camUp.disabled = true; camUp.style.display = 'none'; }
  if (camDown) { camDown.disabled = true; camDown.style.display = 'none'; }
  if (camLeft) { camLeft.disabled = true; camLeft.style.display = 'none'; }
  if (camRight) { camRight.disabled = true; camRight.style.display = 'none'; }
  if (camReset) camReset.addEventListener('click', () => resetCamera(lastSnapshot));

  const basePan = () => 42;
  const panStep = () => basePan() * Math.max(1.0, camera.zoom * 0.55);
  if (camUp && !camUp.disabled) bindHold(camUp, () => nudgeCamera(0, panStep()));
  if (camDown && !camDown.disabled) bindHold(camDown, () => nudgeCamera(0, -panStep()));
  if (camLeft && !camLeft.disabled) bindHold(camLeft, () => nudgeCamera(panStep(), 0));
  if (camRight && !camRight.disabled) bindHold(camRight, () => nudgeCamera(-panStep(), 0));

  cv.addEventListener('wheel', (e) => {
    e.preventDefault();
    // zoom –æ—Ç–∫–ª—é—á–µ–Ω
  }, { passive: false });

  function showWelcomeOnce() {
    try {
      const k = 'evosim_welcome_shown';
      if (localStorage.getItem(k) === '1') return;
      localStorage.setItem(k, '1');
      if (!welcomeModal) return;
      welcomeModal.classList.add('open');
    } catch (e) {}
  }

  function hideWelcome() {
    try { if (welcomeModal) welcomeModal.classList.remove('open'); } catch (e) {}
  }

  if (btnCloseWelcome) btnCloseWelcome.addEventListener('click', hideWelcome);
  if (btnWelcomeOk) btnWelcomeOk.addEventListener('click', hideWelcome);

  function showCookieOnce() {
    try {
      const k = 'evosim_cookie_ok';
      if (localStorage.getItem(k) === '1') return;
      if (cookieBar) cookieBar.style.display = 'flex';
    } catch (e) {}
  }

  function acceptCookies() {
    try {
      localStorage.setItem('evosim_cookie_ok', '1');
      if (cookieBar) cookieBar.style.display = 'none';
    } catch (e) {}
  }

  if (btnCookieAccept) btnCookieAccept.addEventListener('click', acceptCookies);

  try {
    showWelcomeOnce();
    showCookieOnce();
  } catch (e) {}

  cv.addEventListener('contextmenu', (e) => e.preventDefault());

  cv.addEventListener('mousedown', (e) => {
    // Like in admin editor: pan with RMB/MMB, keep LMB for selection/hover.
    if (e.button !== 1 && e.button !== 2) return;
    dragging = true;
    dragStart = { x: e.clientX, y: e.clientY, cx: camera.x, cy: camera.y };
  });
  window.addEventListener('mouseup', () => { dragging = false; dragStart = null; });
  window.addEventListener('mousemove', (e) => {
    if (!dragging || !dragStart) return;
    const dx = e.clientX - dragStart.x;
    const dy = e.clientY - dragStart.y;
    camera.x = dragStart.cx + dx;
    camera.y = dragStart.cy + dy;
    clampCamera(lastSnapshot);
  });

  cv.addEventListener('dblclick', (e) => {
    e.preventDefault();
    centerOnAgents(lastSnapshot);
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === 'r' || e.key === 'R') {
      resetCamera(lastSnapshot);
    }
  });

  const ruAction = {
    move: '–∏–¥—ë—Ç',
    gather: '—Å–æ–±–∏—Ä–∞–µ—Ç',
    consume: '–µ—Å—Ç',
    drink: '–ø—å—ë—Ç',
    sleep: '—Å–ø–∏—Ç',
    communicate: '–æ–±—â–∞–µ—Ç—Å—è',
    mate: '—Å–ø–∞—Ä–∏–≤–∞–µ—Ç—Å—è',
    care: '–∑–∞–±–æ—Ç–∏—Ç—Å—è –æ —Ä–µ–±—ë–Ω–∫–µ',
    combine: '–∫—Ä–∞—Ñ—Ç–∏—Ç',
    break: '–ª–æ–º–∞–µ—Ç',
    attack: '–æ—Ö–æ—Ç–∏—Ç—Å—è',
    rest: '–æ—Ç–¥—ã—Ö–∞–µ—Ç',
  };

  function actionToRu(action) {
    if (!action) return '...';
    return ruAction[action] || '–¥–µ–π—Å—Ç–≤—É–µ—Ç';
  }

  function renderHistory(snapshot) {
    const el = document.getElementById('history');
    if (!el) return;
    const items = snapshot.history || [];
    el.innerHTML = '';

    const reasonRu = {
      '—Å–º–µ—Ä—Ç—å –ê–¥–∞–º–∞ –∏ –ï–≤—ã': '–≤—Å–µ –∞–≥–µ–Ω—Ç—ã –ø–æ–≥–∏–±–ª–∏',
      '–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫': '–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫',
      '–æ—à–∏–±–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏': '–æ—à–∏–±–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏',
      '–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã': '–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã',
      '–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞': '–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞',
    };

    if (!items.length) {
      const div = document.createElement('div');
      div.className = 'event';
      div.textContent = '–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –ø—É—Å—Ç–∞—è.';
      el.appendChild(div);
      return;
    }

    for (let i = items.length - 1; i >= 0; i--) {
      const h = items[i];
      const div = document.createElement('div');
      div.className = 'event';
      let extra = '';
      if (h.reason_details) {
        const d = h.reason_details;
        const agent = d.agent_id ? ` (${d.agent_id})` : '';
        const hng = (d.hunger === undefined || d.hunger === null) ? '‚Äî' : d.hunger.toFixed(2);
        const thr = (d.thirst === undefined || d.thirst === null) ? '‚Äî' : d.thirst.toFixed(2);
        const slp = (d.sleepiness === undefined || d.sleepiness === null) ? '‚Äî' : d.sleepiness.toFixed(2);
        const eng = (d.energy === undefined || d.energy === null) ? '‚Äî' : d.energy.toFixed(2);
        const hlth = (d.health === undefined || d.health === null) ? '‚Äî' : d.health.toFixed(2);
        const age = (d.age === undefined || d.age === null) ? '‚Äî' : d.age;
        if (d.cause_ru) {
          extra = `; ${d.cause_ru}${agent}; –≥–æ–ª–æ–¥=${hng} –∂–∞–∂–¥–∞=${thr} —Å–æ–Ω=${slp} —ç–Ω–µ—Ä–≥–∏—è=${eng} –∑–¥–æ—Ä–æ–≤—å–µ=${hlth} –≤–æ–∑—Ä–∞—Å—Ç=${age}`;
        } else if (d.message) {
          const where = d.where ? ` (${d.where})` : '';
          extra = `; ${d.message}${where}`;
          if (d.traceback) {
            try {
              const lines = String(d.traceback).split('\n').map(s => s.trim()).filter(Boolean);
              const tail = lines.slice(Math.max(0, lines.length - 6));
              const hint = tail.join(' | ');
              extra += `; tb: ${hint}`;
            } catch (e) {}
          }
        } else if (d.note) {
          extra = `; ${d.note}`;
        }
      }
      const rru = reasonRu[h.reason] || h.reason || '–∑–∞–≤–µ—Ä—à—ë–Ω';
      const dur = h.duration_sec_wall ? ` ¬∑ ${h.duration_sec_wall.toFixed(1)}s` : '';
      const ts = h.ended_at_timestep ? `t=${h.ended_at_timestep}` : '';
      const dy = h.ended_at_day ? `–¥–µ–Ω—å ${h.ended_at_day}` : '';
      const tm = h.ended_at_time ? h.ended_at_time : '';
      const when = [ts, dy, tm].filter(Boolean).join(' ');
      const whenStr = when ? `; ${when}` : '';
      div.textContent = `run #${h.run}: ${rru}${whenStr}${dur}${extra}`;
      el.appendChild(div);
    }
  }

  function getSpriteSheet(sex) {
    if (sex === 'female') return sprites.female;
    return sprites.male;
  }

  function getFrameRect(img, col, row) {
    const fw = Math.floor(img.width / 4);
    const fh = Math.floor(img.height / 2);
    return { sx: col * fw, sy: row * fh, sw: fw, sh: fh };
  }

  function chooseFrame(agent, timestep) {
    // Sheet layout assumption:
    // row 0: walk cycle (2 frames) + (unused/back)
    // row 1: sit, gather/crouch, eat frame A, eat frame B
    const action = agent.last_action || 'rest';
    const phase = timestep % 2;

    if (action === 'move') {
      return { col: phase, row: 0, flip: agent.facing === 'right' };
    }
    if (action === 'gather' || action === 'combine') {
      return { col: 1, row: 1, flip: agent.facing === 'right' };
    }
    if (action === 'consume') {
      return { col: 2 + phase, row: 1, flip: agent.facing === 'right' };
    }
    // rest + default
    return { col: 0, row: 1, flip: agent.facing === 'right' };
  }

  function ping() {
    try { ws.send('ping'); } catch (e) {}
  }

  function colorForObject(type) {
    const map = { stone:'#8b8f9f', wood:'#9b6b3d', plant:'#2bd46a', berry:'#ff3b3b', bone:'#e7e7e7', fiber:'#ffd35c', animal:'#ff9a3b' };
    return map[type] || '#4aa3ff';
  }

  function colorForAgent(a) {
    if (a.health > 0.7) return '#41d67e';
    if (a.health > 0.4) return '#ffcf5c';
    return '#ff4d6d';
  }

  const ruObj = {
    stone: '–∫–∞–º–µ–Ω—å',
    wood: '–¥–µ—Ä–µ–≤–æ',
    plant: '—Ä–∞—Å—Ç–µ–Ω–∏–µ',
    berry: '—è–≥–æ–¥—ã',
    bone: '–∫–æ—Å—Ç—å',
    fiber: '–≤–æ–ª–æ–∫–Ω–æ',
    animal: '–º—è—Å–æ',
    water: '–≤–æ–¥–∞',
  };

  const ruToolKind = {
    wooden_axe: '–¥–µ—Ä–µ–≤—è–Ω–Ω—ã–π —Ç–æ–ø–æ—Ä',
    wooden_spear: '–¥–µ—Ä–µ–≤—è–Ω–Ω–æ–µ –∫–æ–ø—å—ë',
    stone_hammer: '–∫–∞–º–µ–Ω–Ω—ã–π –º–æ–ª–æ—Ç',
  };

  function escapeHtml(s) {
    return String(s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function getHoverSnapshot() {
    const base = lastSnapshot || {};
    const agents = Array.isArray(lastAgents) ? lastAgents : (base.agents || []);
    const objects = Array.from(objectsState.values());
    const world = base.world || { width: 100, height: 100 };
    return { ...base, world, agents, objects };
  }

  function findAgentUnderCursor(snapshot, mx, my) {
    if (!snapshot || !snapshot.agents || snapshot.agents.length === 0) return null;

    const w = snapshot.world.width;
    const h = snapshot.world.height;
    const sx = cv.width / w;
    const sy = cv.height / h;

    const wx = (mx - camera.x) / camera.zoom;
    const wy = (my - camera.y) / camera.zoom;

    let best = null;
    let bestD2 = Infinity;
    const threshold = 18;
    const threshold2 = threshold * threshold;

    for (const a of snapshot.agents) {
      const ax = a.x * sx;
      const ay = a.y * sy;
      const dx = wx - ax;
      const dy = wy - ay;
      const d2 = dx * dx + dy * dy;
      if (d2 < bestD2) {
        bestD2 = d2;
        best = a;
      }
    }

    if (best && bestD2 <= threshold2) return best;
    return null;
  }

  function findObjectUnderCursor(snapshot, mx, my) {
    if (!snapshot || !snapshot.objects || snapshot.objects.length === 0) return null;

    const w = snapshot.world.width;
    const h = snapshot.world.height;
    const sx = cv.width / w;
    const sy = cv.height / h;

    const wx = (mx - camera.x) / camera.zoom;
    const wy = (my - camera.y) / camera.zoom;

    let best = null;
    let bestD2 = Infinity;
    const threshold = 10;
    const threshold2 = threshold * threshold;

    for (const o of snapshot.objects) {
      const ox = o.x * sx;
      const oy = o.y * sy;
      const dx = wx - ox;
      const dy = wy - oy;
      const d2 = dx * dx + dy * dy;
      if (d2 < bestD2) {
        bestD2 = d2;
        best = o;
      }
    }

    if (best && bestD2 <= threshold2) return best;
    return null;
  }

  function renderAgentTooltip(agent) {
    if (!agentTooltip) return;
    if (!agent) {
      agentTooltip.style.display = 'none';
      return;
    }

    const inv = agent.inventory || {};
    const byType = inv.by_type || {};
    const food = inv.food ?? null;

    const invParts = [];
    const keys = Object.keys(byType);
    keys.sort();
    for (const k of keys) {
      const v = byType[k];
      if (!v) continue;
      invParts.push(`${ruObj[k] || k}=${v}`);
    }
    if (food !== null) {
      invParts.push(`–µ–¥–∞=${food}`);
    }

    const tools = agent.tools_list || [];
    const toolParts = [];
    for (const t of tools) {
      const kind = t.kind || null;
      const label = kind ? (ruToolKind[kind] || kind) : (t.tool_type || 'tool');
      const d = (t.durability_left === undefined || t.durability_left === null) ? null : t.durability_left.toFixed(0);
      toolParts.push(d ? `${label} (${d}%)` : `${label}`);
    }

    const title = escapeHtml(agent.name || agent.id);
    const invLine = invParts.length ? escapeHtml(invParts.join(', ')) : '–ø—É—Å—Ç–æ';
    const toolLine = toolParts.length ? escapeHtml(toolParts.join(', ')) : '–Ω–µ—Ç';

    const ownerLine = agent.owner_username
      ? `<div class="muted">—Å–æ–∑–¥–∞—Ç–µ–ª—å: <span class="mono">${escapeHtml(agent.owner_username)}</span></div>`
      : '';

    const swimLine = agent.is_swimming
      ? `<div class="muted">—Å—Ç–∞—Ç—É—Å: <span class="mono">–ø–ª–∞–≤–∞–µ—Ç</span> (${escapeHtml(agent.water_ticks ?? 0)})</div>`
      : '';

    // Personality & mood
    const personalityLine = agent.personality_ru
      ? `<div class="muted">—Ö–∞—Ä–∞–∫—Ç–µ—Ä: <b>${escapeHtml(agent.personality_ru)}</b></div>`
      : '';

    const emotionRu = {happiness:'—Å—á–∞—Å—Ç—å–µ',fear:'—Å—Ç—Ä–∞—Ö',anger:'–∑–ª–æ—Å—Ç—å',loneliness:'–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ',curiosity:'–ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ',contentment:'–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ',pride:'–≥–æ—Ä–¥–æ—Å—Ç—å',grief:'–≥–æ—Ä–µ'};
    const domEmo = agent.dominant_emotion ? (emotionRu[agent.dominant_emotion] || agent.dominant_emotion) : null;
    const moodLine = agent.mood
      ? `<div class="muted">–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: <b>${escapeHtml(agent.mood)}</b>${domEmo ? ' (' + escapeHtml(domEmo) + ')' : ''}</div>`
      : '';

    const thoughtLine = agent.thought
      ? `<div style="color:var(--accent);font-style:italic;margin:4px 0;">üí≠ ${escapeHtml(agent.thought)}</div>`
      : '';

    // Social
    let socialLine = '';
    if (agent.social) {
      const friends = (agent.social.friends || []).slice(0, 3);
      const fam = (agent.social.family || []).length;
      if (friends.length || fam) {
        const parts = [];
        if (fam) parts.push(`—Å–µ–º—å—è: ${fam}`);
        for (const f of friends) {
          const name = findAgentName(f.id);
          parts.push(`${escapeHtml(name)}: ${f.trust > 0.5 ? '‚ù§' : 'üëç'}`);
        }
        socialLine = `<div class="muted">—Å–≤—è–∑–∏: ${parts.join(', ')}</div>`;
      }
    }

    agentTooltip.innerHTML = `
      <div class="title">${title}</div>
      ${ownerLine}
      ${personalityLine}
      ${moodLine}
      ${thoughtLine}
      ${swimLine}
      ${socialLine}
      <div class="muted">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å:</div>
      <div class="mono">${invLine}</div>
      <div style="height:4px"></div>
      <div class="muted">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:</div>
      <div class="mono">${toolLine}</div>
    `;
    agentTooltip.style.display = 'block';
  }

  function findAgentName(id) {
    if (!lastAgents) return id || '?';
    const a = lastAgents.find(x => x.id === id);
    return a ? (a.name || a.id) : (id || '?');
  }

  function renderObjectTooltip(obj) {
    if (!agentTooltip) return;
    if (!obj) {
      agentTooltip.style.display = 'none';
      return;
    }

    const title = `${ruObj[obj.type] || obj.type}`;
    const qty = (obj.quantity === undefined || obj.quantity === null) ? 1 : obj.quantity;

    const nutrition = (obj.nutrition === undefined || obj.nutrition === null) ? null : obj.nutrition;
    const toxicity = (obj.toxicity === undefined || obj.toxicity === null) ? null : obj.toxicity;
    const hardness = (obj.hardness === undefined || obj.hardness === null) ? null : obj.hardness;
    const durability = (obj.durability === undefined || obj.durability === null) ? null : obj.durability;

    const lines = [];
    lines.push(`–∫–æ–ª-–≤–æ=${qty}`);
    if (nutrition !== null && nutrition > 0) lines.push(`–ø–∏—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å=${nutrition.toFixed(2)}`);
    if (toxicity !== null && toxicity > 0) lines.push(`—Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç—å=${toxicity.toFixed(2)}`);
    if (hardness !== null && hardness > 0) lines.push(`—Ç–≤—ë—Ä–¥–æ—Å—Ç—å=${hardness.toFixed(2)}`);
    if (durability !== null && durability > 0) lines.push(`–ø—Ä–æ—á–Ω–æ—Å—Ç—å=${durability.toFixed(2)}`);

    agentTooltip.innerHTML = `
      <div class="title">${escapeHtml(title)}</div>
      <div class="mono">${escapeHtml(lines.join(', '))}</div>
    `;
    agentTooltip.style.display = 'block';
  }

  function positionAgentTooltip(mx, my) {
    if (!agentTooltip) return;
    const pad = 12;
    const wrap = document.getElementById('canvasWrap');
    if (!wrap) return;

    const rect = wrap.getBoundingClientRect();
    const maxX = rect.width - agentTooltip.offsetWidth - pad;
    const maxY = rect.height - agentTooltip.offsetHeight - pad;
    const x = Math.max(pad, Math.min(maxX, mx + pad));
    const y = Math.max(pad, Math.min(maxY, my + pad));
    agentTooltip.style.left = `${x}px`;
    agentTooltip.style.top = `${y}px`;
  }

  cv.addEventListener('mousemove', (e) => {
    if (!lastSnapshot) return;
    const rect = cv.getBoundingClientRect();
    // Mouse is in CSS pixels; convert to canvas pixels for hit-testing.
    const mxCss = e.clientX - rect.left;
    const myCss = e.clientY - rect.top;
    const scaleX = cv.width / rect.width;
    const scaleY = cv.height / rect.height;
    const mx = mxCss * scaleX;
    const my = myCss * scaleY;

    const hs = getHoverSnapshot();
    const a = findAgentUnderCursor(hs, mx, my);
    if (a) {
      renderAgentTooltip(a);
      positionAgentTooltip(mxCss, myCss);
      return;
    }

    const o = findObjectUnderCursor(hs, mx, my);
    if (o) {
      renderObjectTooltip(o);
      positionAgentTooltip(mxCss, myCss);
      return;
    }

    renderAgentTooltip(null);
  });

  cv.addEventListener('mouseleave', () => {
    renderAgentTooltip(null);
  });

  function draw(snapshot) {
    const w = snapshot.world.width;
    const h = snapshot.world.height;

    ctx.clearRect(0, 0, cv.width, cv.height);

    // Apply camera transform
    ctx.save();
    ctx.translate(camera.x, camera.y);
    ctx.scale(camera.zoom, camera.zoom);

    // Scale world to canvas
    const sx = cv.width / w;
    const sy = cv.height / h;

    // Terrain (water) from saved map (cached as 1px-per-cell offscreen)
    if (worldMapCache && worldMapCache.w === w && worldMapCache.h === h) {
      if (!worldMapCache.off) {
        worldMapCache.off = buildWaterOffscreen(w, h, worldMapCache.water);
      }
      if (worldMapCache.off) {
        ctx.globalAlpha = 1.0;
        ctx.drawImage(worldMapCache.off, 0, 0, w * sx, h * sy);
      }
    } else {
      // Map/world size changed (e.g., admin applied a new map). Reload map.
      loadWorldMap();
    }

    // Objects
    for (const o of objectsState.values()) {
      ctx.fillStyle = colorForObject(o.type);
      ctx.globalAlpha = 0.7;
      ctx.fillRect(o.x * sx, o.y * sy, Math.max(1, sx*0.7), Math.max(1, sy*0.7));
    }

    // Agents
    for (const a of snapshot.agents) {
      const prev = agentRenderState.get(a.id) || { x: a.x, y: a.y, facing: 'right' };
      const dx = a.x - prev.x;
      const facing = dx < 0 ? 'left' : dx > 0 ? 'right' : prev.facing;
      agentRenderState.set(a.id, { x: a.x, y: a.y, facing });

      const img = getSpriteSheet(a.sex);
      const ready = img.complete && img.naturalWidth > 0;
      const px = a.x * sx;
      const py = a.y * sy;

      // Draw sprite (fallback to circle if sprite not loaded yet)
      if (ready) {
        const frame = chooseFrame({ ...a, facing }, snapshot.timestep);
        const r = getFrameRect(img, frame.col, frame.row);
        const drawH = a.is_child ? 30 : 44;
        const drawW = Math.round((r.sw / r.sh) * drawH);

        ctx.save();
        ctx.translate(px, py);

        if (frame.flip) {
          ctx.scale(-1, 1);
        }

        // Anchor at feet
        const ox = frame.flip ? -drawW / 2 : -drawW / 2;
        const oy = -drawH;
        ctx.globalAlpha = 1.0;
        ctx.drawImage(img, r.sx, r.sy, r.sw, r.sh, ox, oy, drawW, drawH);
        ctx.restore();
      } else {
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = colorForAgent(a);
        const r = 4;
        ctx.beginPath();
        ctx.arc(px, py, r, 0, Math.PI * 2);
        ctx.fill();
      }

      if (a.is_swimming) {
        ctx.save();
        ctx.globalAlpha = 0.85;
        ctx.strokeStyle = 'rgba(70,160,255,0.95)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(px, py - 2, 9, 0, Math.PI * 2);
        ctx.stroke();
        ctx.restore();
      }

      // Speech bubble: name + status/speech/thought
      const who = a.name || a.id;
      let bubbleText = `${who}`;
      let bubbleBg = '#11162a';
      let bubbleBorder = 'rgba(255,255,255,0.25)';
      let bubbleColor = '#e7e9ee';

      if (a.is_child) {
        bubbleText = `${who} (—Ä–µ–±—ë–Ω–æ–∫)`;
      }
      if (a.pregnant) {
        const pr = a.pregnancy_remaining ?? 0;
        bubbleText = `${who}: –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å (${pr})`;
      }
      if (a.speech) {
        bubbleText = `${who}: ${a.speech}`;
        bubbleBg = '#1a1540';
        bubbleBorder = 'rgba(129,140,248,0.4)';
      } else if (a.thought) {
        bubbleText = `${who}: ${a.thought}`;
        bubbleBg = '#0f1a2e';
        bubbleBorder = 'rgba(99,102,241,0.3)';
        bubbleColor = '#a5b4fc';
      } else if (a.is_swimming) {
        bubbleText = `${who}: –ø–ª–∞–≤–∞–µ—Ç`;
      } else if (a.last_action) {
        bubbleText = `${who}: ${actionToRu(a.last_action)}`;
      }

      // Mood emoji prefix
      if (a.mood_score !== null && a.mood_score !== undefined) {
        let moodIcon = '';
        if (a.mood_score > 0.3) moodIcon = 'üòä';
        else if (a.mood_score > 0) moodIcon = 'üôÇ';
        else if (a.mood_score > -0.3) moodIcon = 'üòê';
        else moodIcon = 'üòü';
        bubbleText = moodIcon + ' ' + bubbleText;
      }

      ctx.save();
      ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      const padX = 6;
      const padY = 4;
      const textW = ctx.measureText(bubbleText).width;
      const bw = textW + padX * 2;
      const bh = 18;
      const bx = px - bw / 2;
      const by = py - 58;
      ctx.globalAlpha = 0.85;
      ctx.fillStyle = bubbleBg;
      ctx.strokeStyle = bubbleBorder;
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(bx, by, bw, bh, 8);
      ctx.fill();
      ctx.stroke();
      ctx.globalAlpha = 1.0;
      ctx.fillStyle = bubbleColor;
      ctx.fillText(bubbleText, bx + padX, by + 13);
      ctx.restore();
    }

    // Night overlay
    if (snapshot.world && snapshot.world.is_daytime === false) {
      ctx.save();
      ctx.globalAlpha = 0.25;
      ctx.fillStyle = '#02040d';
      ctx.fillRect(0, 0, cv.width, cv.height);
      ctx.restore();
    }
  }

  function renderEvents(snapshot) {
    const el = document.getElementById('events');
    el.innerHTML = '';
    const events = snapshot.events || [];
    const nameById = new Map((snapshot.agents || []).map(a => [a.id, a.name || a.id]));
    for (let i = events.length - 1; i >= 0; i--) {
      const e = events[i];
      const div = document.createElement('div');
      div.className = 'event';
      if (e.type === 'agent_action') {
        const who = nameById.get(e.agent_id) || e.agent_id;
        div.textContent = `[t=${e.timestamp}] ${who} -> ${actionToRu(e.action)} —É—Å–ø–µ—Ö=${e.success} –Ω–∞–≥—Ä–∞–¥–∞=${(e.reward ?? 0).toFixed(2)}`;
      } else if (e.type === 'communication') {
        const speaker = nameById.get(e.speaker_id) || e.speaker_id;
        const listener = nameById.get(e.listener_id) || e.listener_id;
        div.textContent = `[t=${e.timestamp}] ${speaker} —Å–∫–∞–∑–∞–ª '${e.token}' ‚Üí ${listener} (—É—Å–ø–µ—Ö=${e.success})`;
      } else {
        const who = e.agent_id ? (nameById.get(e.agent_id) || e.agent_id) : '';
        div.textContent = `[t=${e.timestamp}] ${e.type} ${who}`;
      }
      el.appendChild(div);
    }
  }

  function renderStatus(snapshot) {
    const lang = snapshot.language || {};
    const pct = (x) => (x === undefined || x === null) ? '‚Äî' : `${(x * 100).toFixed(0)}%`;
    const num = (x) => (x === undefined || x === null) ? '‚Äî' : `${x}`;

    const prog = snapshot.progress || {};
    const needsLoad = (prog.needs_load_avg === undefined || prog.needs_load_avg === null) ? '‚Äî' : prog.needs_load_avg.toFixed(2);
    const critical = (prog.critical_share === undefined || prog.critical_share === null) ? '‚Äî' : `${(prog.critical_share * 100).toFixed(0)}%`;
    const avgAge = (prog.avg_age_alive === undefined || prog.avg_age_alive === null) ? '‚Äî' : prog.avg_age_alive.toFixed(0);
    const maxAge = (prog.max_age_alive === undefined || prog.max_age_alive === null) ? '‚Äî' : `${prog.max_age_alive}`;
    const combOk = (prog.combine_success_recent === undefined || prog.combine_success_recent === null) ? '‚Äî' : `${prog.combine_success_recent}`;
    const totalTools = (prog.total_tools === undefined || prog.total_tools === null) ? '‚Äî' : `${prog.total_tools}`;

    const deaths = prog.death_causes_recent || {};
    const deathParts = [];
    const deathKeys = Object.keys(deaths);
    deathKeys.sort();
    for (const k of deathKeys) {
      deathParts.push(`${k}=${deaths[k]}`);
    }
    const deathLine = deathParts.length ? deathParts.join(', ') : '‚Äî';

    const kinds = prog.tool_kinds || {};
    const kindParts = [];
    const kindKeys = Object.keys(kinds);
    kindKeys.sort();
    for (const k of kindKeys) {
      const label = ruToolKind[k] || k;
      kindParts.push(`${label}=${kinds[k]}`);
    }
    const kindLine = kindParts.length ? kindParts.join(', ') : '‚Äî';

    status.innerHTML = `
      <span title="–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å—Ä–µ–¥—ã (¬∞C)"><b>T</b>: ${snapshot.world.temperature.toFixed(1)}¬∞C</span>
      <span title="–°—Ä–µ–¥–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω—É–∂–¥ –ø–æ –∂–∏–≤—ã–º: (–≥–æ–ª–æ–¥+–∂–∞–∂–¥–∞+—Å–æ–Ω–ª–∏–≤–æ—Å—Ç—å)/3"><b>–Ω—É–∂–¥—ã</b>: ${needsLoad}</span>
      <span title="–î–æ–ª—è –∂–∏–≤—ã—Ö –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏"><b>–∫—Ä–∏—Ç–∏—á</b>: ${critical}</span>
      <span title="–í–æ–∑—Ä–∞—Å—Ç: —Å—Ä–µ–¥–Ω–∏–π/–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π"><b>–≤–æ–∑—Ä–∞—Å—Ç</b>: ${avgAge}/${maxAge}</span>
      <span title="–£—Å–ø–µ—à–Ω—ã–µ –∫—Ä–∞—Ñ—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 200 —Å–æ–±—ã—Ç–∏–π"><b>–∫—Ä–∞—Ñ—Ç</b>: ${combOk}</span>
      <span title="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ –º–∏—Ä–µ"><b>–∏–Ω—Å—Ç—Ä—É–º</b>: ${totalTools}</span>
      <span title="–¢–∏–ø—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"><b>—Ç–∏–ø—ã</b>: ${kindLine}</span>
      <span title="–°–º–µ—Ä—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 200 —Å–æ–±—ã—Ç–∏–π"><b>—Å–º–µ—Ä—Ç–∏</b>: ${deathLine}</span>
      <span title="–†–∞–∑–º–µ—Ä —Å–ª–æ–≤–∞—Ä—è"><b>—Å–ª–æ–≤–∞—Ä—å</b>: ${num(lang.lexicon_size)}</span>
      <span title="–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ª–µ–∫—Å–∏–∫–æ–Ω–∞"><b>—Å—Ç–∞–±</b>: ${pct(lang.stability)}</span>
      <span title="–°—Ö–æ–¥–∏–º–æ—Å—Ç—å —è–∑—ã–∫–∞"><b>—Å—Ö–æ–¥–∏–º</b>: ${pct(lang.convergence)}</span>
      <span title="–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏"><b>–∫–æ–º–º</b>: ${pct(lang.comm_success_rate_recent)} (${num(lang.comm_count_recent)})</span>
    `;
  }

  let lastSnapshot = null;
  let lastAgents = [];
  let lastPaintMs = 0;
  const targetFrameMs = 1000 / 30;

  let renderLoopStarted = false;
  function renderLoop(now) {
    try {
      if (lastSnapshot) {
        if (now - lastPaintMs >= targetFrameMs) {
          draw(lastSnapshot);
          lastPaintMs = now;
        }
      }
    } catch (e) {}
    requestAnimationFrame(renderLoop);
  }

  // RTS-style object state (applied from deltas)
  const objectsState = new Map();
  let lastRunNumber = null;

  const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws');

  function ping() {
    try { ws.send('ping'); } catch (e) {}
  }

  ws.onopen = () => {
    // Keep connection alive; server pushes updates.
    setInterval(() => ping(), 1000);
  };

  ws.onmessage = (ev) => {
    let snapshot;
    try {
      snapshot = JSON.parse(ev.data);
    } catch {
      return;
    }

    // Agents may be omitted in delta snapshots; keep the last known list for hover.
    try {
      if (snapshot && Object.prototype.hasOwnProperty.call(snapshot, 'agents') && Array.isArray(snapshot.agents)) {
        lastAgents = snapshot.agents;
      }
    } catch (e) {}

    // Apply object sync/deltas
    try {
      const runNo = snapshot.run_number ?? (snapshot.run_info ? snapshot.run_info.number : null);
      const isNewRun = (runNo !== null && runNo !== undefined && lastRunNumber !== runNo);
      const full = Boolean(snapshot.full_sync) || Boolean(snapshot.objects_full) || isNewRun;

      if (full) {
        objectsState.clear();
        const fullList = snapshot.objects_full || snapshot.objects || [];
        for (const o of fullList) {
          if (!o || !o.id) continue;
          objectsState.set(o.id, o);
        }
        lastRunNumber = runNo;
      } else {
        for (const o of (snapshot.objects_add || [])) {
          if (!o || !o.id) continue;
          objectsState.set(o.id, o);
        }
        for (const o of (snapshot.objects_update || [])) {
          if (!o || !o.id) continue;
          objectsState.set(o.id, o);
        }
        for (const oid of (snapshot.objects_remove || [])) {
          if (!oid) continue;
          objectsState.delete(oid);
        }
      }
    } catch (e) {}

    lastSnapshot = snapshot;
    renderStatus(snapshot);
    renderHistory(snapshot);
    renderEvents(snapshot);
    renderMyAgent(snapshot);
    updateInfoBar(snapshot);

    if (!renderLoopStarted) {
      renderLoopStarted = true;
      lastPaintMs = performance.now();
      requestAnimationFrame(renderLoop);
    }
  };

  ws.onclose = () => {
    status.innerHTML = '<b>WS disconnected</b>';
  };

  const authUser = document.getElementById('authUser');
  const authPass = document.getElementById('authPass');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');
  const btnLogout = document.getElementById('btnLogout');
  const authState = document.getElementById('authState');
  const chatAuth = document.getElementById('chatAuth');
  const chatBox = document.getElementById('chatBox');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const btnSend = document.getElementById('btnSend');
  const chatAnnounce = document.getElementById('chatAnnounce');
  const chatAnnounceText = document.getElementById('chatAnnounceText');

  const worldControls = document.getElementById('worldControls');
  const btnCreateAgent = document.getElementById('btnCreateAgent');
  const createAgentState = document.getElementById('createAgentState');

  const agentModal = document.getElementById('agentModal');
  const btnCloseAgentModal = document.getElementById('btnCloseAgentModal');
  const agentName = document.getElementById('agentName');
  const agentStatsStrength = document.getElementById('agentStatsStrength');
  const agentStatsIntelligence = document.getElementById('agentStatsIntelligence');
  const agentStatsSocial = document.getElementById('agentStatsSocial');
  const agentStatsEndurance = document.getElementById('agentStatsEndurance');
  const agentStatsLeft = document.getElementById('agentStatsLeft');
  const btnPresetInventor = document.getElementById('btnPresetInventor');
  const btnPresetSurvivor = document.getElementById('btnPresetSurvivor');
  const btnPresetLeader = document.getElementById('btnPresetLeader');
  const btnSubmitAgent = document.getElementById('btnSubmitAgent');
  const agentModalState = document.getElementById('agentModalState');

  const accountBar = document.getElementById('accountBar');
  const accountText = document.getElementById('accountText');
  const adminLink = document.getElementById('adminLink');
  const btnLogout2 = document.getElementById('btnLogout2');

  const newsList = document.getElementById('newsList');
  const newsAdmin = document.getElementById('newsAdmin');
  const newsTitle = document.getElementById('newsTitle');
  const newsText = document.getElementById('newsText');
  const btnPostNews = document.getElementById('btnPostNews');
  const newsAdminState = document.getElementById('newsAdminState');

  let chatWs = null;

  function setAuthState(stateText) {
    authState.textContent = stateText || '';
  }

  function localizeDetail(detail) {
    const d = (detail || '').toString();
    if (!d) return '';
    const map = {
      invalid_username_or_password: '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å',
      invalid_credentials: '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å',
      invalid_token: '–°–µ—Å—Å–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.',
      not_authenticated: '–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç',
      not_admin: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (–Ω—É–∂–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)',
      registration_closed: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.',
      admin_already_exists: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–∂–µ —Å–æ–∑–¥–∞–Ω',
      username_taken: '–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç',
      username_too_short: '–õ–æ–≥–∏–Ω —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π',
      password_too_short: '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π',
      invalid_agent_name: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è –∞–≥–µ–Ω—Ç–∞',
      invalid_agent_sex: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ–ª –∞–≥–µ–Ω—Ç–∞',
      invalid_agent_stats: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∞–≥–µ–Ω—Ç–∞',
      simulation_not_ready: '–°–∏–º—É–ª—è—Ü–∏—è –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ.',
      agent_already_created: '–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–≥–µ–Ω—Ç. –ú–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –Ω–∞–±–ª—é–¥–∞—Ç—å –∑–∞ –Ω–∏–º.',
    };
    return map[d] || d;
  }

  function setHasAgentFlag(hasAgent) {
    localStorage.setItem('evosim_has_agent', hasAgent ? '1' : '0');
  }

  function findMyAgent(snapshot) {
    const u = localStorage.getItem('evosim_username') || '';
    if (!u || !snapshot || !snapshot.agents) return null;
    return snapshot.agents.find(a => a.owner_username === u) || null;
  }

  function fmtPct01(x) {
    if (x === undefined || x === null) return '‚Äî';
    return `${Math.round(x * 100)}%`;
  }

  function renderMyAgent(snapshot) {
    if (!myAgentState || !myAgentBody) return;
    const agent = findMyAgent(snapshot);
    if (!agent) {
      myAgentBody.style.display = 'none';
      myAgentState.style.display = '';
      myAgentState.textContent = localStorage.getItem('evosim_has_agent') === '1'
        ? '–í–∞—à –∞–≥–µ–Ω—Ç —Å–µ–π—á–∞—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –º–∏—Ä–µ (–≤–æ–∑–º–æ–∂–Ω–æ, –µ—â—ë –Ω–µ –∑–∞—Å–ø–∞–≤–Ω–∏–ª—Å—è –∏–ª–∏ –ø–æ–≥–∏–±).'
        : '–í–æ–π–¥–∏—Ç–µ –∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–µ–≥–æ –∞–≥–µ–Ω—Ç–∞, —á—Ç–æ–±—ã —Å–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–∏–º.';
      return;
    }

    myAgentBody.style.display = '';
    myAgentState.style.display = 'none';

    myAgentName.textContent = agent.name || agent.id;
    myAgentOwner.textContent = `user: ${agent.owner_username || '‚Äî'}`;

    const swim = agent.is_swimming ? ' ¬∑ –ø–ª–∞–≤–∞–µ—Ç' : '';
    const lastAct = agent.last_action ? ` ¬∑ ${actionToRu(agent.last_action)}` : '';
    myAgentStatus.textContent = `t=${snapshot.timestep} ¬∑ (${agent.x},${agent.y})${swim}${lastAct}`;

    const needs = `–≥–æ–ª–æ–¥ ${fmtPct01(agent.hunger)} ¬∑ –∂–∞–∂–¥–∞ ${fmtPct01(agent.thirst)} ¬∑ —Å–æ–Ω–ª–∏–≤–æ—Å—Ç—å ${fmtPct01(agent.sleepiness)}`;
    myAgentNeeds.textContent = needs;

    const vitals = `–∑–¥–æ—Ä–æ–≤—å–µ ${fmtPct01(agent.health)} ¬∑ —ç–Ω–µ—Ä–≥–∏—è ${fmtPct01(agent.energy)} ¬∑ –≤–æ–∑—Ä–∞—Å—Ç ${agent.age}`;
    myAgentVitals.textContent = vitals;

    // Personality, mood, thought, social (dynamic section)
    let extraHtml = '';
    if (agent.personality_ru) {
      extraHtml += `<div class="text-xs text-muted" style="margin-top:8px;">–•–∞—Ä–∞–∫—Ç–µ—Ä</div><div style="font-size:13px;">${escapeHtml(agent.personality_ru)}</div>`;
    }
    if (agent.mood) {
      const emoRu = {happiness:'—Å—á–∞—Å—Ç—å–µ',fear:'—Å—Ç—Ä–∞—Ö',anger:'–∑–ª–æ—Å—Ç—å',loneliness:'–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ',curiosity:'–ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–æ',contentment:'–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ',pride:'–≥–æ—Ä–¥–æ—Å—Ç—å',grief:'–≥–æ—Ä–µ'};
      const emo = agent.dominant_emotion ? (emoRu[agent.dominant_emotion] || '') : '';
      extraHtml += `<div class="text-xs text-muted" style="margin-top:6px;">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div><div style="font-size:13px;">${escapeHtml(agent.mood)}${emo ? ' ¬∑ ' + escapeHtml(emo) : ''}</div>`;
    }
    if (agent.thought) {
      extraHtml += `<div style="margin-top:6px;color:var(--accent);font-style:italic;font-size:13px;">üí≠ ${escapeHtml(agent.thought)}</div>`;
    }
    if (agent.social) {
      const fam = (agent.social.family || []).length;
      const friends = (agent.social.friends || []).slice(0, 5);
      if (fam || friends.length) {
        extraHtml += `<div class="text-xs text-muted" style="margin-top:6px;">–°–≤—è–∑–∏</div><div style="font-size:13px;">`;
        if (fam) extraHtml += `—Å–µ–º—å—è: ${fam} `;
        for (const f of friends) {
          const n = findAgentName(f.id);
          extraHtml += `${escapeHtml(n)}(${f.trust > 0 ? '+' : ''}${f.trust}) `;
        }
        extraHtml += `</div>`;
      }
    }
    // Render extra section
    const extraEl = document.getElementById('myAgentExtra');
    if (extraEl) extraEl.innerHTML = extraHtml;
  }

  function hasAgent() {
    return localStorage.getItem('evosim_has_agent') === '1';
  }

  function getToken() {
    return localStorage.getItem('evosim_token');
  }

  function setToken(token, username) {
    localStorage.setItem('evosim_token', token);
    if (username) localStorage.setItem('evosim_username', username);
  }

  function setAdminFlag(isAdmin) {
    localStorage.setItem('evosim_is_admin', isAdmin ? '1' : '0');
  }

  function isAdmin() {
    return localStorage.getItem('evosim_is_admin') === '1';
  }

  function clearToken() {
    localStorage.removeItem('evosim_token');
    localStorage.removeItem('evosim_username');
    localStorage.removeItem('evosim_is_admin');
  }

  function setChatAnnouncement(text) {
    const t = String(text || '').trim();
    if (!chatAnnounce || !chatAnnounceText) return;
    if (!t) {
      chatAnnounce.style.display = 'none';
      chatAnnounceText.textContent = '';
      return;
    }
    chatAnnounce.style.display = '';
    chatAnnounceText.textContent = t;
  }

  function appendChatLine(item) {
    const div = document.createElement('div');
    div.className = 'chat-msg';
    div.dataset.msgId = String(item.id ?? '');
    const ts = (item.created_at || '').replace('T', ' ').slice(11, 16);
    const authorSpan = document.createElement('span');
    authorSpan.className = 'chat-author' + (item.is_admin ? ' admin' : '');
    authorSpan.textContent = item.username;
    const textSpan = document.createElement('span');
    textSpan.className = 'chat-text';
    textSpan.textContent = item.text;
    const timeSpan = document.createElement('span');
    timeSpan.className = 'chat-time';
    timeSpan.textContent = ts;
    div.appendChild(authorSpan);
    div.appendChild(textSpan);
    div.appendChild(timeSpan);
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function deleteChatLineById(id) {
    if (!chatMessages) return;
    const q = `[data-msg-id="${CSS.escape(String(id))}"]`;
    const el = chatMessages.querySelector(q);
    if (el) el.remove();
  }

  function setLoggedInUI(username) {
    // Hide login form and show account bar
    authUser.value = '';
    authPass.value = '';
    authUser.disabled = true;
    authPass.disabled = true;
    btnLogin.style.display = 'none';
    btnRegister.style.display = 'none';
    btnLogout.style.display = 'none';
    if (chatAuth) chatAuth.style.display = 'none';
    accountBar.style.display = '';
    chatBox.style.display = '';
    btnSend.disabled = false;
    const tag = isAdmin() ? ' (admin)' : '';
    accountText.textContent = username ? `${username}${tag}` : `–≤—ã –≤–æ—à–ª–∏${tag}`;
    if (accountAvatar) accountAvatar.textContent = username ? username.charAt(0).toUpperCase() : '?';
    adminLink.style.display = isAdmin() ? '' : 'none';
    setAuthState('');
    newsAdmin.style.display = isAdmin() ? '' : 'none';
    if (worldControls) worldControls.style.display = '';

    if (btnCreateAgent) {
      const locked = hasAgent();
      btnCreateAgent.disabled = locked;
      setCreateAgentState(locked ? '–∞–≥–µ–Ω—Ç —É–∂–µ —Å–æ–∑–¥–∞–Ω' : '');
    }
  }

  function setLoggedOutUI() {
    accountBar.style.display = 'none';
    adminLink.style.display = 'none';
    btnLogout.style.display = 'none';
    btnLogin.style.display = '';
    btnRegister.style.display = '';
    if (chatAuth) chatAuth.style.display = '';
    authUser.disabled = false;
    authPass.disabled = false;
    chatBox.style.display = 'none';
    btnSend.disabled = true;
    setAuthState('');
    newsAdmin.style.display = 'none';
    if (worldControls) worldControls.style.display = 'none';
    if (btnCreateAgent) btnCreateAgent.disabled = true;
    setCreateAgentState('');
  }

  function setCreateAgentState(t) {
    if (createAgentState) createAgentState.textContent = t || '';
  }

  function setAgentModalState(t) {
    if (agentModalState) agentModalState.textContent = t || '';
  }

  function readStat(el) {
    try {
      const v = parseInt(el.value || '0', 10);
      if (Number.isNaN(v)) return 0;
      return Math.max(0, Math.min(3, v));
    } catch (e) {
      return 0;
    }
  }

  function writeStat(el, v) {
    try {
      el.value = String(Math.max(0, Math.min(3, parseInt(v || 0, 10) || 0)));
    } catch (e) {}
  }

  function getStatsPoints() {
    return {
      strength: readStat(agentStatsStrength),
      intelligence: readStat(agentStatsIntelligence),
      social: readStat(agentStatsSocial),
      endurance: readStat(agentStatsEndurance),
    };
  }

  function sumStats(s) {
    return (s.strength || 0) + (s.intelligence || 0) + (s.social || 0) + (s.endurance || 0);
  }

  function updateStatsLeft() {
    const s = getStatsPoints();
    const left = 5 - sumStats(s);
    if (agentStatsLeft) {
      agentStatsLeft.textContent = left >= 0 ? `–æ—Å—Ç–∞–ª–æ—Å—å –æ—á–∫–æ–≤: ${left}` : `–ª–∏—à–Ω–∏–µ –æ—á–∫–∏: ${-left}`;
      agentStatsLeft.style.color = left === 0 ? '#41d67e' : (left > 0 ? '#aab0c0' : '#ff4d6d');
    }
    if (btnSubmitAgent) btnSubmitAgent.disabled = (left !== 0);
  }

  function applyPreset(name) {
    if (name === 'inventor') {
      writeStat(agentStatsStrength, 1);
      writeStat(agentStatsIntelligence, 3);
      writeStat(agentStatsSocial, 0);
      writeStat(agentStatsEndurance, 1);
    } else if (name === 'survivor') {
      writeStat(agentStatsStrength, 3);
      writeStat(agentStatsIntelligence, 0);
      writeStat(agentStatsSocial, 0);
      writeStat(agentStatsEndurance, 2);
    } else if (name === 'leader') {
      writeStat(agentStatsStrength, 1);
      writeStat(agentStatsIntelligence, 1);
      writeStat(agentStatsSocial, 3);
      writeStat(agentStatsEndurance, 0);
    }
    updateStatsLeft();
  }

  function openAgentModal() {
    if (!agentModal) return;
    setAgentModalState('');
    if (agentName) agentName.value = '';
    writeStat(agentStatsStrength, 0);
    writeStat(agentStatsIntelligence, 0);
    writeStat(agentStatsSocial, 0);
    writeStat(agentStatsEndurance, 0);
    updateStatsLeft();
    agentModal.classList.add('open');
    try { agentName && agentName.focus(); } catch (e) {}
  }

  function closeAgentModal() {
    if (!agentModal) return;
    agentModal.classList.remove('open');
    setAgentModalState('');
  }

  function getAgentSex() {
    const el = document.querySelector('input[name="agentSex"]:checked');
    return el ? el.value : 'male';
  }

  async function submitAgent() {
    const token = getToken();
    if (!token) {
      setCreateAgentState('–Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏');
      return;
    }
    const name = (agentName && agentName.value ? agentName.value : '').trim();
    const sex = getAgentSex();
    const stats = getStatsPoints();
    if (sumStats(stats) !== 5) {
      setAgentModalState('–Ω—É–∂–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–æ–≤–Ω–æ 5 –æ—á–∫–æ–≤');
      return;
    }
    setAgentModalState('...');
    try {
      const res = await fetch('/api/agents/create?token=' + encodeURIComponent(token), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ display_name: name, sex, stats })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        setAgentModalState(localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
        return;
      }
      const a = data.agent || {};
      setCreateAgentState(`—Å–æ–∑–¥–∞–Ω: ${a.name || a.id}`);
      setHasAgentFlag(true);
      if (btnCreateAgent) btnCreateAgent.disabled = true;
      closeAgentModal();
    } catch (e) {
      setAgentModalState('–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
  }

  async function validateTokenAndSyncUI() {
    const token = getToken();
    if (!token) {
      setLoggedOutUI();
      return;
    }
    try {
      const res = await fetch('/api/auth/me?token=' + encodeURIComponent(token), { cache: 'no-store' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        clearToken();
        setLoggedOutUI();
        return;
      }
      localStorage.setItem('evosim_username', data.username);
      setAdminFlag(!!data.is_admin);
      setHasAgentFlag(!!data.has_agent);
      setLoggedInUI(data.username);
    } catch (e) {
      // If network fails, fall back to stored info
      const username = localStorage.getItem('evosim_username') || '';
      setLoggedInUI(username);
    }
  }

  function connectChat() {
    const token = getToken();
    if (!token) {
      setLoggedOutUI();
      return;
    }

    const username = localStorage.getItem('evosim_username') || '';
    setLoggedInUI(username);
    chatMessages.innerHTML = '';

    if (chatWs) {
      try { chatWs.close(); } catch (e) {}
      chatWs = null;
    }

    const wsUrl = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/chat/ws?token=' + encodeURIComponent(token);
    chatWs = new WebSocket(wsUrl);

    chatWs.onmessage = (ev) => {
      let msg;
      try { msg = JSON.parse(ev.data); } catch { return; }
      if (msg.type === 'history') {
        const items = msg.items || [];
        chatMessages.innerHTML = '';
        for (const it of items) appendChatLine(it);
        setChatAnnouncement(msg.announcement || '');
        return;
      }
      if (msg.type === 'message' && msg.item) {
        appendChatLine(msg.item);
        return;
      }
      if (msg.type === 'announcement') {
        setChatAnnouncement(msg.text || '');
        return;
      }
      if (msg.type === 'moderation' && msg.event === 'delete') {
        deleteChatLineById(msg.id);
        return;
      }
      if (msg.type === 'banned') {
        setAuthState('–≤—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —á–∞—Ç–µ');
        try { if (chatBox) chatBox.style.display = 'none'; } catch (e) {}
        return;
      }
      if (msg.type === 'error' && msg.detail === 'chat_banned') {
        setAuthState('–≤—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —á–∞—Ç–µ');
        return;
      }
    };

    chatWs.onclose = () => {
      setAuthState('—á–∞—Ç –æ—Ç–∫–ª—é—á–µ–Ω');
    };
  }

  async function authCall(path) {
    const username = (authUser.value || '').trim();
    const password = authPass.value || '';
    setAuthState('...');
    const res = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      setAuthState(localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }
    setToken(data.token, data.username);
    setAdminFlag(!!data.is_admin);
    connectChat();
    await loadNews();
  }

  btnLogin.addEventListener('click', async () => {
    try { await authCall('/api/auth/login'); } catch (e) { setAuthState('–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });
  btnRegister.addEventListener('click', async () => {
    try { await authCall('/api/auth/register'); } catch (e) { setAuthState('–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  });
  btnLogout.addEventListener('click', () => {
    clearToken();
    if (chatWs) {
      try { chatWs.close(); } catch (e) {}
      chatWs = null;
    }
    setLoggedOutUI();
    loadNews();
  });

  if (btnCreateAgent) btnCreateAgent.addEventListener('click', () => openAgentModal());
  if (btnCloseAgentModal) btnCloseAgentModal.addEventListener('click', () => closeAgentModal());
  if (agentModal) {
    agentModal.addEventListener('click', (e) => {
      if (e.target === agentModal) closeAgentModal();
    });
  }
  if (btnSubmitAgent) btnSubmitAgent.addEventListener('click', () => submitAgent());

  if (agentStatsStrength) agentStatsStrength.addEventListener('input', () => updateStatsLeft());
  if (agentStatsIntelligence) agentStatsIntelligence.addEventListener('input', () => updateStatsLeft());
  if (agentStatsSocial) agentStatsSocial.addEventListener('input', () => updateStatsLeft());
  if (agentStatsEndurance) agentStatsEndurance.addEventListener('input', () => updateStatsLeft());
  if (btnPresetInventor) btnPresetInventor.addEventListener('click', () => applyPreset('inventor'));
  if (btnPresetSurvivor) btnPresetSurvivor.addEventListener('click', () => applyPreset('survivor'));
  if (btnPresetLeader) btnPresetLeader.addEventListener('click', () => applyPreset('leader'));

  updateStatsLeft();

  btnLogout2.addEventListener('click', () => {
    clearToken();
    if (chatWs) {
      try { chatWs.close(); } catch (e) {}
      chatWs = null;
    }
    setLoggedOutUI();
    loadNews();
  });

  function setNewsAdminState(t) {
    newsAdminState.textContent = t || '';
  }

  function renderNews(items) {
    newsList.innerHTML = '';
    const arr = items || [];
    for (let i = arr.length - 1; i >= 0; i--) {
      const n = arr[i];
      const wrap = document.createElement('div');
      wrap.className = 'news-item';

      const t = (n.created_at || '').replace('T', ' ').slice(0, 19);
      const title = document.createElement('div');
      title.className = 'news-title';
      title.textContent = n.title;
      const meta = document.createElement('div');
      meta.className = 'news-meta';
      meta.textContent = `${t} ‚Äî ${n.author_username}`;
      const body = document.createElement('div');
      body.className = 'news-body';
      body.textContent = n.text;

      wrap.appendChild(title);
      wrap.appendChild(meta);
      wrap.appendChild(body);

      if (isAdmin() && getToken()) {
        const row = document.createElement('div');
        row.style.marginTop = '8px';
        const btnDel = document.createElement('button');
        btnDel.className = 'btn btn-danger btn-xs';
        btnDel.textContent = '–£–¥–∞–ª–∏—Ç—å';
        btnDel.addEventListener('click', async () => {
          try {
            const res = await fetch('/api/admin/news/' + n.id + '?token=' + encodeURIComponent(getToken()), { method: 'DELETE' });
            if (!res.ok) return;
            await loadNews();
          } catch (e) {}
        });
        row.appendChild(btnDel);
        wrap.appendChild(row);
      }

      newsList.appendChild(wrap);
    }
  }

  async function loadNews() {
    try {
      const res = await fetch('/api/news?limit=20', { cache: 'no-store' });
      const data = await res.json().catch(() => ({}));
      renderNews(data.items || []);
    } catch (e) {
      // ignore
    }
  }

  btnPostNews.addEventListener('click', async () => {
    if (!getToken()) return;
    setNewsAdminState('...');
    try {
      const title = (newsTitle.value || '').trim();
      const text = (newsText.value || '').trim();
      const res = await fetch('/api/admin/news?token=' + encodeURIComponent(getToken()), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, text }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        setNewsAdminState(localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
        return;
      }
      newsTitle.value = '';
      newsText.value = '';
      setNewsAdminState('–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ');
      await loadNews();
    } catch (e) {
      setNewsAdminState('–æ—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
  });

  function sendChat() {
    const text = (chatInput.value || '').trim();
    if (!text) return;
    if (!chatWs || chatWs.readyState !== WebSocket.OPEN) {
      setAuthState('—á–∞—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
      return;
    }
    chatWs.send(JSON.stringify({ text }));
    chatInput.value = '';
  }

  btnSend.addEventListener('click', sendChat);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendChat();
  });

  validateTokenAndSyncUI();
  connectChat();
  loadNews();
  loadWorldMap();
</script>
</body>
</html>
