<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    button { font-family:inherit; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted { color:var(--text-muted); font-size:12px; line-height:1.4; }
    .mono { font-family:var(--font-mono); }
    .pad { padding:16px; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .item { border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:12px; background:var(--bg-glass); }
    .split { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:5px 12px; border-radius:100px; border:1px solid var(--border-default); background:var(--bg-glass); font-size:12px; color:var(--text-secondary); }
    .dot { width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,0.25); }
    .dot.ok { background:var(--success); }
    .dot.warn { background:var(--warning); }
    .panel { background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:var(--radius-lg); overflow:hidden; }
    .panel h3 { margin:0; padding:12px 16px; border-bottom:1px solid var(--border-subtle); font-size:0.85rem; font-weight:600; color:var(--text-accent); display:flex; align-items:center; justify-content:space-between; gap:10px; }
    @media(max-width:980px){ .split{grid-template-columns:1fr;} }
  </style>
</head>
<body>
<div class="admin-layout">

  <!-- ===== SIDEBAR NAV ===== -->
  <aside class="admin-sidebar">
    <div class="admin-sidebar-header">
      <h2 style="display:flex; align-items:center; gap:8px;">
        <svg width="22" height="22" viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="46" stroke="#818cf8" stroke-width="6"/><circle cx="35" cy="40" r="8" fill="#818cf8"/><circle cx="65" cy="40" r="8" fill="#6366f1"/><path d="M30 65 Q50 82 70 65" stroke="#818cf8" stroke-width="5" fill="none" stroke-linecap="round"/></svg>
        –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      </h2>
      <div class="admin-user" id="globalState"><span class="dot warn" style="display:inline-block;"></span> <span class="mono">status‚Ä¶</span></div>
    </div>
    <nav class="admin-nav">
      <div class="admin-nav-item active" id="tabUsers" data-panel="usersPanel"><span class="nav-icon">üë•</span> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
      <div class="admin-nav-item" id="tabNews" data-panel="newsPanel"><span class="nav-icon">üì∞</span> –ù–æ–≤–æ—Å—Ç–∏</div>
      <div class="admin-nav-item" id="tabMap" data-panel="mapPanel"><span class="nav-icon">üó∫</span> –ö–∞—Ä—Ç–∞</div>
      <div class="admin-nav-item" id="tabTools" data-panel="toolsPanel"><span class="nav-icon">üîß</span> –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
      <div class="admin-nav-item" id="tabSite" data-panel="sitePanel"><span class="nav-icon">‚öô</span> SEO / –°–∞–π—Ç</div>
      <div class="admin-nav-item" id="tabPrivacy" data-panel="privacyPanel"><span class="nav-icon">üîí</span> –ü–æ–ª–∏—Ç–∏–∫–∞</div>
      <div class="admin-nav-item" id="tabChat" data-panel="chatPanel"><span class="nav-icon">üí¨</span> –ß–∞—Ç</div>
      <div class="admin-nav-item" id="tabSprites" data-panel="spritesPanel"><span class="nav-icon">üé®</span> –¢–µ–∫—Å—Ç—É—Ä—ã</div>
      <div class="admin-nav-item" id="tabAnimals" data-panel="animalsPanel"><span class="nav-icon">üêæ</span> –ñ–∏–≤–æ—Ç–Ω—ã–µ</div>
    </nav>
    <div class="admin-sidebar-footer">
      <a href="/" class="btn btn-secondary btn-sm w-full" style="text-align:center; display:block;">‚Üê –ö —Å–∏–º—É–ª—è—Ü–∏–∏</a>
    </div>
  </aside>

  <!-- ===== MAIN CONTENT ===== -->
  <main class="admin-main">
    <div class="admin-main-content">

      <!-- Auth Cards (always visible at top) -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
        <div class="panel">
          <h3>Bootstrap –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
          <div class="pad">
            <div class="muted" style="margin-bottom:10px;">
              –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –±–∞–∑–µ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
            </div>
            <div class="split">
              <input id="bootUser" placeholder="username" />
              <input id="bootPass" type="password" placeholder="password (‚â•6)" />
            </div>
            <div class="row" style="margin-top:10px; justify-content:space-between;">
              <button id="btnBootstrap" class="btn btn-primary btn-sm">–°–æ–∑–¥–∞—Ç—å admin</button>
              <div class="muted">–ü—É–±–ª–∏—á–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç –∑–∞–∫—Ä—ã—Ç–∞</div>
            </div>
            <div id="bootState" class="muted" style="margin-top:8px;"></div>
          </div>
        </div>

        <div class="panel">
          <h3>–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
          <div class="pad">
            <div class="split">
              <input id="loginUser" placeholder="username" />
              <input id="loginPass" type="password" placeholder="password" />
            </div>
            <div class="row" style="margin-top:10px; justify-content:space-between;">
              <div class="row">
                <button id="btnLogin" class="btn btn-primary btn-sm">–í–æ–π—Ç–∏</button>
                <button id="btnLogout" class="btn btn-secondary btn-sm" style="display:none;">–í—ã–π—Ç–∏</button>
              </div>
              <div class="muted">–¢–æ–∫–µ–Ω –≤ <span class="mono">localStorage</span></div>
            </div>
            <div id="loginState" class="muted" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>

      <!-- Section: Users -->
      <div id="usersPanel" class="admin-section active">
        <div class="panel" style="margin-bottom:12px;">
          <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ <button id="btnReloadUsers" class="btn btn-secondary btn-xs" style="margin-left:auto;">–û–±–Ω–æ–≤–∏—Ç—å</button></h3>
          <div class="pad">
            <div id="usersState" class="muted" style="margin-bottom:8px;"></div>

            <div class="item" style="margin-bottom:12px;">
              <div class="muted" style="margin-bottom:8px;">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
              <div class="split">
                <input id="newUser" placeholder="username" />
                <input id="newPass" type="password" placeholder="password (‚â•6)" />
              </div>
              <div class="row" style="margin-top:10px; justify-content:space-between;">
                <label class="row muted" style="gap:8px;">
                  <input id="newIsAdmin" type="checkbox" />
                  –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                </label>
                <button id="btnCreateUser" class="btn btn-primary btn-sm">–°–æ–∑–¥–∞—Ç—å</button>
              </div>
              <div id="createUserState" class="muted" style="margin-top:8px;"></div>
            </div>

            <div id="usersList" class="list"></div>

            <div class="item" style="margin-top:12px;">
              <div class="row" style="justify-content:space-between; margin-bottom:8px;">
                <div>
                  <b>–ê–≥–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</b>
                  <div class="muted">–£–¥–∞–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É ¬´1 –∞–≥–µ–Ω—Ç –Ω–∞–≤—Å–µ–≥–¥–∞¬ª</div>
                </div>
                <button id="btnReloadUserAgents" class="btn btn-secondary btn-xs">–û–±–Ω–æ–≤–∏—Ç—å</button>
              </div>
              <div id="userAgentsState" class="muted" style="margin-bottom:8px;"></div>
              <div id="userAgentsList" class="list"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: News -->
      <div id="newsPanel" class="admin-section">
        <div class="panel">
          <h3>–ù–æ–≤–æ—Å—Ç–∏ <button id="btnReloadNews" class="btn btn-secondary btn-xs" style="margin-left:auto;">–û–±–Ω–æ–≤–∏—Ç—å</button></h3>
          <div class="pad">
            <div id="newsState" class="muted" style="margin-bottom:8px;"></div>

            <div class="item" style="margin-bottom:12px;">
              <div class="muted" style="margin-bottom:8px;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å</div>
              <input id="newsTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" style="width:100%; margin-bottom:8px;" />
              <textarea id="newsText" placeholder="–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏"></textarea>
              <div class="row" style="margin-top:8px;">
                <button id="btnPostNews" class="btn btn-primary btn-sm">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                <div id="postNewsState" class="muted"></div>
              </div>
            </div>

            <div id="newsList" class="list"></div>
          </div>
        </div>
      </div>

      <!-- Section: Map -->
      <div id="mapPanel" class="admin-section">
        <div class="panel">
          <h3>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç—ã</h3>
          <div class="pad">
            <div class="row" style="justify-content:space-between; margin-bottom:12px;">
              <div class="row" style="gap:10px;">
                <div class="form-group">
                  <label class="text-xs">–®–∏—Ä–∏–Ω–∞</label>
                  <input id="mapW" type="number" min="10" max="300" style="width:100px;" />
                </div>
                <div class="form-group">
                  <label class="text-xs">–í—ã—Å–æ—Ç–∞</label>
                  <input id="mapH" type="number" min="10" max="300" style="width:100px;" />
                </div>
                <div class="form-group">
                  <label class="text-xs">–ö–∏—Å—Ç—å</label>
                  <select id="mapBrush">
                    <option value="water">–í–æ–¥–∞</option>
                    <option value="erase_water">–õ–∞—Å—Ç–∏–∫ –≤–æ–¥—ã</option>
                    <option value="wood">–î–µ—Ä–µ–≤–æ</option>
                    <option value="stone">–ö–∞–º–µ–Ω—å</option>
                    <option value="plant">–†–∞—Å—Ç–µ–Ω–∏—è</option>
                    <option value="berry">–Ø–≥–æ–¥—ã</option>
                    <option value="bone">–ö–æ—Å—Ç–∏</option>
                    <option value="fiber">–í–æ–ª–æ–∫–Ω–æ</option>
                    <option value="erase_obj">–õ–∞—Å—Ç–∏–∫ —Ä–µ—Å—É—Ä—Å–æ–≤</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <button id="btnMapLoad" class="btn btn-secondary btn-sm">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <button id="btnMapSave" class="btn btn-secondary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="btnMapApply" class="btn btn-primary btn-sm">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
              </div>
            </div>
            <div class="row" style="justify-content:space-between; margin-bottom:10px;">
              <div class="muted">–õ–ö–ú ‚Äî —Ä–∏—Å–æ–≤–∞—Ç—å. –ü–ö–ú/—Å—Ä–µ–¥–Ω—è—è ‚Äî –ø–∞–Ω–æ—Ä–∞–º–∞. –ö–æ–ª—ë—Å–∏–∫–æ ‚Äî –º–∞—Å—à—Ç–∞–±.</div>
              <div id="mapState" class="muted"></div>
            </div>

            <div style="display:flex; gap:12px; align-items:flex-start;">
              <div style="flex:1; border:1px solid var(--border-subtle); border-radius:var(--radius-md); overflow:hidden; background:#070b14;">
                <canvas id="mapCanvas" width="900" height="520" style="width:100%; height:520px; display:block;"></canvas>
              </div>
              <div style="width:200px;">
                <div class="muted" style="margin-bottom:6px;">–ú–∏–Ω–∏–∫–∞—Ä—Ç–∞</div>
                <div style="border:1px solid var(--border-subtle); border-radius:var(--radius-sm); overflow:hidden; background:#070b14;">
                  <canvas id="mapMini" width="200" height="200" style="width:100%; height:200px; display:block;"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Tools -->
      <div id="toolsPanel" class="admin-section">
        <div class="panel">
          <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (—Ä–µ—Ü–µ–ø—Ç—ã –∫—Ä–∞—Ñ—Ç–∞)</h3>
          <div class="pad">
            <div class="row" style="justify-content:space-between; margin-bottom:12px;">
              <div class="row">
                <button id="btnToolsReload" class="btn btn-secondary btn-sm">–û–±–Ω–æ–≤–∏—Ç—å</button>
                <button id="btnToolsSave" class="btn btn-secondary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="btnToolsExport" class="btn btn-secondary btn-sm">–≠–∫—Å–ø–æ—Ä—Ç</button>
                <button id="btnToolsImport" class="btn btn-secondary btn-sm">–ò–º–ø–æ—Ä—Ç</button>
              </div>
              <div id="toolsState" class="muted"></div>
            </div>

            <details class="item" style="margin-bottom:12px;">
              <summary class="muted" style="cursor:pointer; font-weight:600;">–®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ —Ä–µ—Ü–µ–ø—Ç–∞–º</summary>
              <div class="mono" style="white-space:pre-wrap; font-size:12px; color:var(--text-accent); margin-top:8px;">
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (ingredients):
  - obj:wood, obj:stone, obj:bone, obj:fiber, obj:plant, obj:berry
  - tool:KIND  (—Ç–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º kind)

–ú–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:
  obj:wood, obj:wood, obj:stone

kind –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º (–æ–¥–∏–Ω kind = –æ–¥–∏–Ω —Ä–µ—Ü–µ–ø—Ç)

Effectiveness keys (–¥–µ–π—Å—Ç–≤–∏—è): gather, attack, break, craft, move, rest

–ü—Ä–∏–º–µ—Ä—ã:
  kind=flint_knife
  components=obj:stone, obj:bone
  gather=1.4 break=1.1 attack=1.2

  kind=super_axe
  components=tool:wooden_axe, obj:stone
  gather=2.2 break=1.6
              </div>
            </details>

            <div class="item" style="margin-bottom:12px;">
              <div class="muted" style="margin-bottom:8px;">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç</div>
              <div class="split">
                <input id="toolKind" placeholder="kind (–Ω–∞–ø—Ä–∏–º–µ—Ä: flint_knife)" />
                <input id="toolDur" type="number" min="5" max="100" placeholder="durability (5..100)" />
              </div>
              <input id="toolComponents" placeholder="components: obj:wood, obj:stone" style="width:100%; margin-top:8px;" />
              <div class="split" style="margin-top:8px;">
                <input id="toolEffGather" type="number" step="0.1" placeholder="gather" />
                <input id="toolEffAttack" type="number" step="0.1" placeholder="attack" />
              </div>
              <div class="split" style="margin-top:8px;">
                <input id="toolEffBreak" type="number" step="0.1" placeholder="break" />
                <input id="toolEffCraft" type="number" step="0.1" placeholder="craft" />
              </div>
              <div class="split" style="margin-top:8px;">
                <input id="toolPropSharp" type="number" step="0.05" placeholder="sharpness (0..1)" />
                <input id="toolPropEff" type="number" step="0.05" placeholder="effectiveness" />
              </div>
              <div class="row" style="margin-top:10px; justify-content:space-between;">
                <button id="btnToolsAdd" class="btn btn-primary btn-sm">–î–æ–±–∞–≤–∏—Ç—å</button>
                <div class="muted">–ü–æ—Ç–æ–º –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª</div>
              </div>
            </div>

            <div id="toolsList" class="list"></div>

            <div id="toolsJsonBox" class="item" style="display:none; margin-top:12px;">
              <div class="muted" style="margin-bottom:8px;">JSON</div>
              <textarea id="toolsJson" style="height:220px;" placeholder='{"version":1,"recipes":[...]}'></textarea>
              <div class="row" style="justify-content:space-between; margin-top:8px;">
                <button id="btnToolsJsonApply" class="btn btn-primary btn-sm">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button id="btnToolsJsonClose" class="btn btn-secondary btn-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>
              <div id="toolsJsonState" class="muted" style="margin-top:8px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: SEO / Site -->
      <div id="sitePanel" class="admin-section">
        <div class="panel">
          <h3>SEO / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞</h3>
          <div class="pad">
            <div class="row" style="justify-content:space-between; margin-bottom:12px;">
              <div class="row">
                <button id="btnSiteLoad" class="btn btn-secondary btn-sm">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <button id="btnSiteSave" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
              <div id="siteState" class="muted"></div>
            </div>

            <div class="muted" style="margin-bottom:12px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–ª–∏—è—é—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É: –∑–∞–≥–æ–ª–æ–≤–æ–∫, meta-—Ç–µ–≥–∏ –∏ –±–∞–Ω–Ω–µ—Ä.</div>

            <div class="item" style="margin-bottom:12px;">
              <div class="form-group" style="margin-bottom:10px;">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                <input id="siteProjectName" placeholder="WorldSE" />
              </div>
              <div class="form-group" style="margin-bottom:10px;">
                <label>SEO: title</label>
                <input id="siteSeoTitle" placeholder="WorldSE" />
              </div>
              <div class="form-group" style="margin-bottom:10px;">
                <label>SEO: description</label>
                <textarea id="siteSeoDescription" style="height:80px;" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–∞–π—Ç–∞..."></textarea>
              </div>
              <div class="form-group" style="margin-bottom:10px;">
                <label>SEO: keywords</label>
                <input id="siteSeoKeywords" placeholder="—Å–∏–º—É–ª—è—Ü–∏—è, –∞–≥–µ–Ω—Ç—ã, —ç–≤–æ–ª—é—Ü–∏—è..." />
              </div>
              <div class="form-group" style="margin-bottom:10px;">
                <label>OG image URL</label>
                <input id="siteOgImage" placeholder="https://.../image.png" />
              </div>
              <div class="form-group">
                <label>Favicon URL</label>
                <input id="siteFaviconUrl" placeholder="https://.../favicon.svg" />
              </div>
            </div>

            <div class="item">
              <div class="form-group">
                <label>–ë–∞–Ω–Ω–µ—Ä HTML (728x90)</label>
                <div class="muted" style="margin-bottom:8px;">–ö–æ–¥ iframe –±–∞–Ω–Ω–µ—Ä–Ω–æ–π —Å–µ—Ç–∏. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —à–∞–ø–∫–µ.</div>
                <textarea id="siteBannerHtml" style="height:140px;" placeholder="<iframe ...></iframe>"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Privacy -->
      <div id="privacyPanel" class="admin-section">
        <div class="panel">
          <h3>–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</h3>
          <div class="pad">
            <div class="row" style="justify-content:space-between; margin-bottom:12px;">
              <div class="row">
                <button id="btnPrivacyLoad" class="btn btn-secondary btn-sm">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                <button id="btnPrivacySave" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              </div>
              <div id="privacyState" class="muted"></div>
            </div>
            <div class="muted" style="margin-bottom:8px;">–¢–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ <span class="mono">/privacy</span>.</div>
            <textarea id="privacyText" style="height:360px;" placeholder="–¢–µ–∫—Å—Ç –ø–æ–ª–∏—Ç–∏–∫–∏..."></textarea>
          </div>
        </div>
      </div>

      <!-- Section: Chat -->
      <div id="chatPanel" class="admin-section">
        <div class="panel">
          <h3>–ß–∞—Ç: –º–æ–¥–µ—Ä–∞—Ü–∏—è –∏ –∞–Ω–æ–Ω—Å</h3>
          <div class="pad">
            <div class="item" style="margin-bottom:12px;">
              <div class="row" style="justify-content:space-between; margin-bottom:10px;">
                <div class="row">
                  <button id="btnChatAnnLoad" class="btn btn-secondary btn-sm">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–æ–Ω—Å</button>
                  <button id="btnChatAnnSave" class="btn btn-primary btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–æ–Ω—Å</button>
                </div>
                <div id="chatAnnState" class="muted"></div>
              </div>
              <div class="muted" style="margin-bottom:8px;">–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–∞—Ç–∞.</div>
              <textarea id="chatAnnText" style="height:100px;" placeholder="–¢–µ–∫—Å—Ç –∞–Ω–æ–Ω—Å–∞..."></textarea>
            </div>

            <div class="item" style="margin-bottom:12px;">
              <div class="row" style="justify-content:space-between; margin-bottom:10px;">
                <button id="btnChatReload" class="btn btn-secondary btn-sm">–û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç (–ø–æ—Å–ª. 50)</button>
                <div id="chatModState" class="muted"></div>
              </div>
              <div id="chatMessagesAdmin" class="list"></div>
            </div>

            <div class="item">
              <div class="muted" style="margin-bottom:8px;">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
              <div class="split">
                <input id="chatBanUserId" type="number" placeholder="user_id" />
                <select id="chatBanMode">
                  <option value="ban">–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</option>
                  <option value="unban">—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</option>
                </select>
              </div>
              <div class="row" style="margin-top:10px; justify-content:space-between;">
                <button id="btnChatBan" class="btn btn-primary btn-sm">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <div class="muted">user_id ‚Äî –≤–æ –≤–∫–ª–∞–¥–∫–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPRITES / TEXTURES PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="spritesPanel" class="admin-section">
        <div class="panel" style="margin-bottom:16px;">
          <h3>üé® –¢–µ–∫—Å—Ç—É—Ä—ã –º–∏—Ä–∞ ‚Äî –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
          <div class="pad">
            <div class="muted" style="line-height:1.6;">
              <b>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–µ–∫—Å—Ç—É—Ä–∞–º:</b><br>
              ‚Ä¢ –§–æ—Ä–º–∞—Ç: <b>PNG</b> (–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)<br>
              ‚Ä¢ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: –¥–æ <b>2 –ú–ë</b><br>
              ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: <b>64√ó64 px</b> –∏–ª–∏ <b>128√ó128 px</b> (—Ç–∞–π–ª–∏—Ç—Å—è –ø–æ –∫–∞—Ä—Ç–µ)<br>
              ‚Ä¢ –¢–µ–∫—Å—Ç—É—Ä–∞ –∑–µ–º–ª–∏ ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω –º–∏—Ä–∞, –∑–∞–º–µ–Ω—è–µ—Ç —á—ë—Ä–Ω—ã–π —Ü–≤–µ—Ç<br>
              ‚Ä¢ –¢–µ–∫—Å—Ç—É—Ä—ã –±–∏–æ–º–æ–≤ ‚Äî –¥–ª—è –±—É–¥—É—â–∏—Ö —Ä–∞–∑–Ω—ã—Ö –∑–æ–Ω –∫–∞—Ä—Ç—ã (–ª–µ—Å, –ø—É—Å—Ç—ã–Ω—è, –≥–æ—Ä—ã, –±–æ–ª–æ—Ç–æ)<br>
              ‚Ä¢ –ó–∏–º–Ω–∏–µ —Ç–µ–∫—Å—Ç—É—Ä—ã ‚Äî –¥–ª—è —Å–Ω–µ–∂–Ω–æ–≥–æ —Å–µ–∑–æ–Ω–∞<br><br>
              <b>–°–ª–æ—Ç—ã —Ç–µ–∫—Å—Ç—É—Ä:</b><br>
              ‚Ä¢ <b>ground</b> ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –∑–µ–º–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è)<br>
              ‚Ä¢ <b>water</b> ‚Äî –≤–æ–¥–∞ (–æ–∑—ë—Ä–∞, —Ä–µ–∫–∏)<br>
              ‚Ä¢ <b>ground_forest</b> ‚Äî –ª–µ—Å–Ω–æ–π –±–∏–æ–º<br>
              ‚Ä¢ <b>ground_desert</b> ‚Äî –ø—É—Å—Ç—ã–Ω—è<br>
              ‚Ä¢ <b>ground_mountain</b> ‚Äî –≥–æ—Ä—ã<br>
              ‚Ä¢ <b>ground_swamp</b> ‚Äî –±–æ–ª–æ—Ç–æ<br>
              ‚Ä¢ <b>ground_winter</b> ‚Äî –∑–∏–º–Ω—è—è –∑–µ–º–ª—è (—Å–Ω–µ–≥)<br>
              ‚Ä¢ <b>ground_winter_forest</b> ‚Äî –∑–∏–º–Ω–∏–π –ª–µ—Å<br>
              ‚Ä¢ <b>ground_winter_desert</b> ‚Äî –∑–∏–º–Ω—è—è –ø—É—Å—Ç—ã–Ω—è
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—Å—Ç—É—Ä <span id="spritesState" class="muted"></span></h3>
          <div class="pad">
            <div id="spriteSlotsList" class="list"></div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ANIMALS PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div id="animalsPanel" class="admin-section">
        <div class="panel" style="margin-bottom:16px;">
          <h3>üêæ –°–æ–∑–¥–∞—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ</h3>
          <div class="pad">
            <div class="split" style="margin-bottom:8px;">
              <div>
                <label class="muted">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input id="animalName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–æ–ª–∫" />
              </div>
              <div>
                <label class="muted">–°—Ç–∞—Ç—É—Å</label>
                <select id="animalStatus">
                  <option value="active">–ê–∫—Ç–∏–≤–Ω–æ</option>
                  <option value="passive">–ü–∞—Å—Å–∏–≤–Ω–æ–µ</option>
                  <option value="hostile">–í—Ä–∞–∂–¥–µ–±–Ω–æ–µ</option>
                  <option value="friendly">–î—Ä—É–∂–µ–ª—é–±–Ω–æ–µ</option>
                  <option value="disabled">–û—Ç–∫–ª—é—á–µ–Ω–æ</option>
                </select>
              </div>
            </div>
            <div class="split" style="margin-bottom:8px;">
              <div>
                <label class="muted">–ó–¥–æ—Ä–æ–≤—å–µ (1‚Äì10000)</label>
                <input id="animalHealth" type="number" value="100" min="1" max="10000" />
              </div>
              <div>
                <label class="muted">–°–∫–æ—Ä–æ—Å—Ç—å (0.1‚Äì10)</label>
                <input id="animalSpeed" type="number" value="1.0" min="0.1" max="10" step="0.1" />
              </div>
            </div>
            <div class="split" style="margin-bottom:8px;">
              <div>
                <label class="muted">–£—Ä–æ–Ω (0‚Äì1000)</label>
                <input id="animalDamage" type="number" value="10" min="0" max="1000" />
              </div>
              <div>
                <label class="muted">–ë—Ä–æ–Ω—è (0‚Äì1000)</label>
                <input id="animalArmor" type="number" value="0" min="0" max="1000" />
              </div>
            </div>
            <div class="split" style="margin-bottom:8px;">
              <div>
                <label class="muted">–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å (0.0‚Äì1.0)</label>
                <input id="animalAggression" type="number" value="0.5" min="0" max="1" step="0.05" />
              </div>
              <div>
                <label class="muted">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <input id="animalDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..." />
              </div>
            </div>
            <div class="row" style="margin-top:10px; justify-content:space-between;">
              <button id="btnAnimalCreate" class="btn btn-primary btn-sm">–°–æ–∑–¥–∞—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ</button>
              <div id="animalCreateState" class="muted"></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>–°–ø–∏—Å–æ–∫ –∂–∏–≤–æ—Ç–Ω—ã—Ö
            <span style="display:flex; gap:6px; align-items:center;">
              <button id="btnAnimalsReload" class="btn btn-secondary btn-xs">–û–±–Ω–æ–≤–∏—Ç—å</button>
              <span id="animalsState" class="muted"></span>
            </span>
          </h3>
          <div class="pad">
            <div id="animalsList" class="list"></div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<script>
  const globalState = document.getElementById('globalState');

  const tabUsers = document.getElementById('tabUsers');
  const tabNews = document.getElementById('tabNews');
  const tabMap = document.getElementById('tabMap');
  const tabTools = document.getElementById('tabTools');
  const tabSite = document.getElementById('tabSite');
  const tabPrivacy = document.getElementById('tabPrivacy');
  const tabChat = document.getElementById('tabChat');
  const tabSprites = document.getElementById('tabSprites');
  const tabAnimals = document.getElementById('tabAnimals');
  const usersPanel = document.getElementById('usersPanel');
  const newsPanel = document.getElementById('newsPanel');
  const mapPanel = document.getElementById('mapPanel');
  const toolsPanel = document.getElementById('toolsPanel');
  const sitePanel = document.getElementById('sitePanel');
  const privacyPanel = document.getElementById('privacyPanel');
  const chatPanel = document.getElementById('chatPanel');
  const spritesPanel = document.getElementById('spritesPanel');
  const animalsPanel = document.getElementById('animalsPanel');

  const bootUser = document.getElementById('bootUser');
  const bootPass = document.getElementById('bootPass');
  const btnBootstrap = document.getElementById('btnBootstrap');
  const bootState = document.getElementById('bootState');

  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  const btnLogin = document.getElementById('btnLogin');
  const btnLogout = document.getElementById('btnLogout');
  const loginState = document.getElementById('loginState');

  const btnReloadUsers = document.getElementById('btnReloadUsers');
  const usersState = document.getElementById('usersState');
  const usersList = document.getElementById('usersList');

  const btnReloadUserAgents = document.getElementById('btnReloadUserAgents');
  const userAgentsState = document.getElementById('userAgentsState');
  const userAgentsList = document.getElementById('userAgentsList');
  const newUser = document.getElementById('newUser');
  const newPass = document.getElementById('newPass');
  const newIsAdmin = document.getElementById('newIsAdmin');
  const btnCreateUser = document.getElementById('btnCreateUser');
  const createUserState = document.getElementById('createUserState');

  const btnReloadNews = document.getElementById('btnReloadNews');
  const newsState = document.getElementById('newsState');
  const newsList = document.getElementById('newsList');
  const newsTitle = document.getElementById('newsTitle');
  const newsText = document.getElementById('newsText');
  const btnPostNews = document.getElementById('btnPostNews');
  const postNewsState = document.getElementById('postNewsState');

  const mapW = document.getElementById('mapW');
  const mapH = document.getElementById('mapH');
  const mapBrush = document.getElementById('mapBrush');
  const btnMapLoad = document.getElementById('btnMapLoad');
  const btnMapSave = document.getElementById('btnMapSave');
  const btnMapApply = document.getElementById('btnMapApply');
  const mapState = document.getElementById('mapState');
  const mapCanvas = document.getElementById('mapCanvas');
  const mapCtx = mapCanvas ? mapCanvas.getContext('2d') : null;
  const mapMini = document.getElementById('mapMini');
  const miniCtx = mapMini ? mapMini.getContext('2d') : null;

  const btnToolsReload = document.getElementById('btnToolsReload');
  const btnToolsSave = document.getElementById('btnToolsSave');
  const btnToolsAdd = document.getElementById('btnToolsAdd');
  const btnToolsExport = document.getElementById('btnToolsExport');
  const btnToolsImport = document.getElementById('btnToolsImport');
  const toolsState = document.getElementById('toolsState');
  const toolsList = document.getElementById('toolsList');

  const toolsJsonBox = document.getElementById('toolsJsonBox');
  const toolsJson = document.getElementById('toolsJson');
  const btnToolsJsonApply = document.getElementById('btnToolsJsonApply');
  const btnToolsJsonClose = document.getElementById('btnToolsJsonClose');
  const toolsJsonState = document.getElementById('toolsJsonState');

  const toolKind = document.getElementById('toolKind');
  const toolDur = document.getElementById('toolDur');
  const toolComponents = document.getElementById('toolComponents');
  const toolEffGather = document.getElementById('toolEffGather');
  const toolEffAttack = document.getElementById('toolEffAttack');
  const toolEffBreak = document.getElementById('toolEffBreak');
  const toolEffCraft = document.getElementById('toolEffCraft');
  const toolPropSharp = document.getElementById('toolPropSharp');
  const toolPropEff = document.getElementById('toolPropEff');

  const btnPrivacyLoad = document.getElementById('btnPrivacyLoad');
  const btnPrivacySave = document.getElementById('btnPrivacySave');
  const privacyState = document.getElementById('privacyState');
  const privacyText = document.getElementById('privacyText');

  const btnSiteLoad = document.getElementById('btnSiteLoad');
  const btnSiteSave = document.getElementById('btnSiteSave');
  const siteState = document.getElementById('siteState');
  const siteProjectName = document.getElementById('siteProjectName');
  const siteSeoTitle = document.getElementById('siteSeoTitle');
  const siteSeoDescription = document.getElementById('siteSeoDescription');
  const siteSeoKeywords = document.getElementById('siteSeoKeywords');
  const siteOgImage = document.getElementById('siteOgImage');
  const siteBannerHtml = document.getElementById('siteBannerHtml');
  const siteFaviconUrl = document.getElementById('siteFaviconUrl');

  const btnChatAnnLoad = document.getElementById('btnChatAnnLoad');
  const btnChatAnnSave = document.getElementById('btnChatAnnSave');
  const chatAnnState = document.getElementById('chatAnnState');
  const chatAnnText = document.getElementById('chatAnnText');

  const btnChatReload = document.getElementById('btnChatReload');
  const chatModState = document.getElementById('chatModState');
  const chatMessagesAdmin = document.getElementById('chatMessagesAdmin');
  const chatBanUserId = document.getElementById('chatBanUserId');
  const chatBanMode = document.getElementById('chatBanMode');
  const btnChatBan = document.getElementById('btnChatBan');

  let toolsData = { version: 1, recipes: [] };

  let mapData = { version: 1, width: 100, height: 100, terrain: { water: [] }, objects: [], settings: { disable_random_water_lakes: true, disable_random_initial_resources: true } };
  const mapCam = { x: 0, y: 0, zoom: 1.0 };
  const mapBaseCell = 12;
  let mapIsDown = false;
  let mapIsPan = false;
  let panPrev = null;

  function getToken() {
    return localStorage.getItem('evosim_token');
  }

  function setToken(token) {
    localStorage.setItem('evosim_token', token);
  }

  function clearToken() {
    localStorage.removeItem('evosim_token');
    localStorage.removeItem('evosim_username');
    localStorage.removeItem('evosim_is_admin');
  }

  function setText(el, t) {
    el.textContent = t || '';
  }

  function localizeDetail(detail) {
    const d = (detail || '').toString();
    if (!d) return '';
    const map = {
      invalid_username_or_password: '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å',
      invalid_credentials: '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å',
      invalid_token: '–°–µ—Å—Å–∏—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞. –í–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.',
      not_authenticated: '–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç',
      not_admin: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (–Ω—É–∂–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)',
      registration_closed: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ–∑–¥–∞—ë—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.',
      admin_only: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (–Ω—É–∂–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)',
      username_taken: '–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç',
      username_too_short: '–õ–æ–≥–∏–Ω —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π',
      password_too_short: '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π',
      invalid_user_id: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π user_id',
      unknown_slot: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–æ—Ç —Ç–µ–∫—Å—Ç—É—Ä—ã',
      only_png: '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç PNG',
      file_too_large: '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 2 –ú–ë)',
      sprite_not_found: '–°–ø—Ä–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω',
      animal_not_found: '–ñ–∏–≤–æ—Ç–Ω–æ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
      invalid_direction: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (up/down/left/right)',
    };
    return map[d] || d;
  }

  async function loadUserAgents() {
    const token = getToken();
    if (!token) return;
    setText(userAgentsState, '...');
    const { res, data } = await jsonFetch('/api/admin/user_agents?token=' + encodeURIComponent(token), { cache: 'no-store' });
    if (!res.ok) {
      setText(userAgentsState, localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }

    const items = data.items || [];
    setText(userAgentsState, `–∞–≥–µ–Ω—Ç–æ–≤: ${items.length}`);
    userAgentsList.innerHTML = '';

    for (const a of items) {
      const div = document.createElement('div');
      div.className = 'item';
      const created = (a.created_at || '').replace('T', ' ').slice(0, 19);
      let statsLine = '';
      try {
        const st = JSON.parse(a.stats_json || '{}');
        statsLine = `—Å–∏–ª=${st.strength ?? 0}, –∏–Ω—Ç=${st.intelligence ?? 0}, —Å–æ—Ü=${st.social ?? 0}, –≤—ã–Ω=${st.endurance ?? 0}`;
      } catch (e) {}
      div.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div>
            <b>${escapeHtml(a.display_name || '')}</b>
            <span class="muted">(${escapeHtml(a.sex || '')})</span>
            <div class="muted">user: <span class="mono">${escapeHtml(a.username || '')}</span> ¬∑ uid=${escapeHtml(a.uid)}</div>
            <div class="muted">—Å–æ–∑–¥–∞–Ω: ${escapeHtml(created)}${statsLine ? ' ¬∑ ' + escapeHtml(statsLine) : ''}</div>
          </div>
          <div class="row">
            <button class="btn btn-danger btn-xs" data-act="delete">–£–¥–∞–ª–∏—Ç—å –∞–≥–µ–Ω—Ç–∞</button>
          </div>
        </div>
      `;
      const btnDel = div.querySelector('button[data-act="delete"]');
      btnDel.addEventListener('click', async () => {
        try {
          const { res: r, data: d } = await jsonFetch('/api/admin/user_agents/' + a.uid + '?token=' + encodeURIComponent(token), { method: 'DELETE' });
          if (!r.ok) {
            setText(userAgentsState, localizeDetail(d.detail) || `–û—à–∏–±–∫–∞ ${r.status}`);
            return;
          }
          await loadUserAgents();
        } catch (e) {}
      });
      userAgentsList.appendChild(div);
    }
  }

  function setPill(el, kind, text) {
    if (!el) return;
    const k = kind || 'warn';
    const safe = String(text || '');
    el.innerHTML = `<span class="dot ${k}"></span><span class="mono">${escapeHtml(safe)}</span>`;
  }

  function showTab(which) {
    const isUsers = which === 'users';
    const isNews = which === 'news';
    const isMap = which === 'map';
    const isTools = which === 'tools';
    const isSite = which === 'site';
    const isPrivacy = which === 'privacy';
    const isChat = which === 'chat';
    const isSprites = which === 'sprites';
    const isAnimals = which === 'animals';
    // Update sidebar nav active state
    document.querySelectorAll('.admin-nav-item').forEach(el => el.classList.remove('active'));
    if (tabUsers && isUsers) tabUsers.classList.add('active');
    if (tabNews && isNews) tabNews.classList.add('active');
    if (tabMap && isMap) tabMap.classList.add('active');
    if (tabTools && isTools) tabTools.classList.add('active');
    if (tabSite && isSite) tabSite.classList.add('active');
    if (tabPrivacy && isPrivacy) tabPrivacy.classList.add('active');
    if (tabChat && isChat) tabChat.classList.add('active');
    if (tabSprites && isSprites) tabSprites.classList.add('active');
    if (tabAnimals && isAnimals) tabAnimals.classList.add('active');
    // Update section visibility via admin-section active class
    document.querySelectorAll('.admin-section').forEach(el => el.classList.remove('active'));
    if (usersPanel && isUsers) usersPanel.classList.add('active');
    if (newsPanel && isNews) newsPanel.classList.add('active');
    if (mapPanel && isMap) mapPanel.classList.add('active');
    if (toolsPanel && isTools) toolsPanel.classList.add('active');
    if (sitePanel && isSite) sitePanel.classList.add('active');
    if (privacyPanel && isPrivacy) privacyPanel.classList.add('active');
    if (chatPanel && isChat) chatPanel.classList.add('active');
    if (spritesPanel && isSprites) spritesPanel.classList.add('active');
    if (animalsPanel && isAnimals) animalsPanel.classList.add('active');
    if (isMap) {
      drawMap();
    }
    if (isTools) {
      renderToolsList();
    }
    if (isSprites) {
      loadSpriteSlots();
    }
    if (isAnimals) {
      loadAnimals();
    }
  }

  function setSiteState(t) {
    if (siteState) siteState.textContent = t || '';
  }

  async function loadSiteSettings() {
    const token = getToken();
    if (!token) {
      setSiteState('–Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏');
      return;
    }
    setSiteState('–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶');
    try {
      const res = await fetch(`/api/admin/site_settings?token=${encodeURIComponent(token)}`, { cache: 'no-store' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(localizeDetail(data && data.detail));
      const s = (data && data.site) ? data.site : {};
      if (siteProjectName) siteProjectName.value = String(s.project_name || '');
      if (siteSeoTitle) siteSeoTitle.value = String(s.seo_title || '');
      if (siteSeoDescription) siteSeoDescription.value = String(s.seo_description || '');
      if (siteSeoKeywords) siteSeoKeywords.value = String(s.seo_keywords || '');
      if (siteOgImage) siteOgImage.value = String(s.seo_og_image || '');
      if (siteBannerHtml) siteBannerHtml.value = String(s.banner_html || '');
      if (siteFaviconUrl) siteFaviconUrl.value = String(s.favicon_url || '');
      setSiteState('ok');
    } catch (e) {
      setSiteState(String(e && e.message ? e.message : e));
    }
  }

  async function saveSiteSettings() {
    const token = getToken();
    if (!token) {
      setSiteState('–Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏');
      return;
    }
    setSiteState('—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶');
    try {
      const payload = {
        project_name: (siteProjectName ? siteProjectName.value : ''),
        seo_title: (siteSeoTitle ? siteSeoTitle.value : ''),
        seo_description: (siteSeoDescription ? siteSeoDescription.value : ''),
        seo_keywords: (siteSeoKeywords ? siteSeoKeywords.value : ''),
        seo_og_image: (siteOgImage ? siteOgImage.value : ''),
        banner_html: (siteBannerHtml ? siteBannerHtml.value : ''),
        favicon_url: (siteFaviconUrl ? siteFaviconUrl.value : ''),
      };
      const res = await fetch(`/api/admin/site_settings?token=${encodeURIComponent(token)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(localizeDetail(data && data.detail));
      setSiteState('ok');
    } catch (e) {
      setSiteState(String(e && e.message ? e.message : e));
    }
  }

  function setPrivacyState(t) {
    if (privacyState) privacyState.textContent = t || '';
  }

  async function loadPrivacy() {
    const token = getToken();
    if (!token) {
      setPrivacyState('–Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏');
      return;
    }
    setPrivacyState('–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶');
    try {
      const res = await fetch(`/api/admin/privacy?token=${encodeURIComponent(token)}`, { cache: 'no-store' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(localizeDetail(data && data.detail));
      const p = (data && data.privacy) ? data.privacy : {};
      if (privacyText) privacyText.value = String(p.text || '');
      setPrivacyState('ok');
    } catch (e) {
      setPrivacyState(String(e && e.message ? e.message : e));
    }
  }

  async function savePrivacy() {
    const token = getToken();
    if (!token) {
      setPrivacyState('–Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏');
      return;
    }
    setPrivacyState('—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶');
    try {
      const payload = { text: (privacyText ? privacyText.value : '') };
      const res = await fetch(`/api/admin/privacy?token=${encodeURIComponent(token)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(localizeDetail(data && data.detail));
      setPrivacyState('ok');
    } catch (e) {
      setPrivacyState(String(e && e.message ? e.message : e));
    }
  }

  function setToolsState(t) {
    if (toolsState) toolsState.textContent = t || '';
  }

  function renderToolsList() {
    if (!toolsList) return;
    const items = (toolsData && toolsData.recipes) ? toolsData.recipes : [];
    toolsList.innerHTML = '';
    for (let i = 0; i < items.length; i++) {
      const r = items[i];
      const wrap = document.createElement('div');
      wrap.className = 'item';
      const comps = (r.components || []).join(', ');
      const eff = r.effectiveness || {};
      const props = r.properties || {};
      const effStr = JSON.stringify(eff);
      const propsStr = JSON.stringify(props);

      wrap.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div style="flex:1;">
            <div class="row" style="justify-content:space-between;">
              <div><b>${escapeHtml(r.kind || 'tool')}</b></div>
              <button class="btn btn-danger btn-xs" data-del="${i}">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div style="margin-top:8px;" class="muted">components</div>
            <input data-comps="${i}" value="${escapeHtml(comps)}" style="width:100%;" />
            <div class="split" style="margin-top:8px;">
              <div>
                <div class="muted">durability_left</div>
                <input data-dur="${i}" type="number" min="5" max="100" value="${escapeHtml(String(r.durability_left ?? ''))}" />
              </div>
              <div>
                <div class="muted">effectiveness JSON</div>
                <input data-eff="${i}" value="${escapeHtml(effStr)}" style="width:100%;" />
              </div>
            </div>
            <div style="margin-top:8px;" class="muted">properties JSON (optional)</div>
            <input data-props="${i}" value="${escapeHtml(propsStr)}" style="width:100%;" />
          </div>
        </div>
      `;
      const btn = wrap.querySelector('button[data-del]');
      if (btn) {
        btn.addEventListener('click', () => {
          try {
            toolsData.recipes.splice(i, 1);
          } catch (e) {}
          renderToolsList();
        });
      }

      const inpComps = wrap.querySelector('input[data-comps]');
      if (inpComps) {
        inpComps.addEventListener('input', () => {
          const v = String(inpComps.value || '');
          toolsData.recipes[i].components = v.split(',').map(s => s.trim()).filter(Boolean);
        });
      }
      const inpDur = wrap.querySelector('input[data-dur]');
      if (inpDur) {
        inpDur.addEventListener('input', () => {
          const n = Number(inpDur.value);
          if (Number.isFinite(n)) toolsData.recipes[i].durability_left = n;
        });
      }
      const inpEff = wrap.querySelector('input[data-eff]');
      if (inpEff) {
        inpEff.addEventListener('input', () => {
          try {
            const obj = JSON.parse(String(inpEff.value || '{}'));
            if (obj && typeof obj === 'object') toolsData.recipes[i].effectiveness = obj;
          } catch (e) {}
        });
      }
      const inpProps = wrap.querySelector('input[data-props]');
      if (inpProps) {
        inpProps.addEventListener('input', () => {
          try {
            const obj = JSON.parse(String(inpProps.value || '{}'));
            if (obj && typeof obj === 'object') toolsData.recipes[i].properties = obj;
          } catch (e) {}
        });
      }

      toolsList.appendChild(wrap);
    }
    if (items.length === 0) {
      const div = document.createElement('div');
      div.className = 'muted';
      div.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤';
      toolsList.appendChild(div);
    }
  }

  async function loadTools() {
    const token = getToken();
    if (!token) return;
    setToolsState('...');
    const { res, data } = await jsonFetch('/api/admin/tools?token=' + encodeURIComponent(token), { cache: 'no-store' });
    if (!res.ok) {
      setToolsState(localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }
    toolsData = data.tools || { version: 1, recipes: [] };
    renderToolsList();
    setToolsState('');
  }

  async function saveTools() {
    const token = getToken();
    if (!token) return;
    setToolsState('...');
    const { res, data } = await jsonFetch('/api/admin/tools?token=' + encodeURIComponent(token), {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(toolsData)
    });
    if (!res.ok) {
      setToolsState(localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }
    setToolsState('—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  }

  function parseNum(v) {
    if (v === undefined || v === null) return null;
    const s = String(v).trim();
    if (!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function addToolRecipeFromForm() {
    const kind = (toolKind.value || '').trim();
    const compsRaw = (toolComponents.value || '').trim();
    const dur = parseNum(toolDur.value);
    const g = parseNum(toolEffGather.value);
    const a = parseNum(toolEffAttack.value);
    const b = parseNum(toolEffBreak.value);
    const c = parseNum(toolEffCraft.value);
    if (!kind || !compsRaw) {
      setToolsState('–ó–∞–ø–æ–ª–Ω–∏ kind –∏ components');
      return;
    }

    const comps = compsRaw.split(',').map(s => s.trim()).filter(Boolean);
    if (comps.length < 2) {
      setToolsState('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞');
      return;
    }
    const eff = {};
    if (g !== null) eff.gather = g;
    if (a !== null) eff.attack = a;
    if (b !== null) eff.break = b;
    if (c !== null) eff.craft = c;
    if (Object.keys(eff).length === 0) {
      setToolsState('–£–∫–∞–∂–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ effectiveness –∑–Ω–∞—á–µ–Ω–∏–µ');
      return;
    }
    const props = {};
    const sh = parseNum(toolPropSharp.value);
    const pe = parseNum(toolPropEff.value);
    if (sh !== null) props.sharpness = sh;
    if (pe !== null) props.effectiveness = pe;
    const item = {
      kind,
      components: comps,
      effectiveness: eff,
      durability_left: dur !== null ? dur : 60,
      properties: props,
    };
    toolsData.recipes = toolsData.recipes || [];
    const exists = toolsData.recipes.some(r => String(r.kind || '').trim() === kind);
    if (exists) {
      setToolsState('kind —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º)');
      return;
    }
    toolsData.recipes.push(item);
    renderToolsList();
    setToolsState('–¥–æ–±–∞–≤–ª–µ–Ω–æ (–Ω–µ –∑–∞–±—É–¥—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å)');
  }

  function setToolsJsonState(t) {
    if (toolsJsonState) toolsJsonState.textContent = t || '';
  }

  function openToolsJsonBox(mode) {
    if (!toolsJsonBox || !toolsJson) return;
    toolsJsonBox.style.display = '';
    setToolsJsonState('');
    if (mode === 'export') {
      toolsJson.value = JSON.stringify(toolsData, null, 2);
    }
    if (mode === 'import') {
      toolsJson.value = JSON.stringify(toolsData, null, 2);
    }
  }

  function closeToolsJsonBox() {
    if (!toolsJsonBox) return;
    toolsJsonBox.style.display = 'none';
  }

  function applyToolsJson() {
    if (!toolsJson) return;
    setToolsJsonState('...');
    try {
      const parsed = JSON.parse(String(toolsJson.value || ''));
      if (!parsed || typeof parsed !== 'object') {
        setToolsJsonState('–ù–µ–≤–µ—Ä–Ω—ã–π JSON');
        return;
      }
      if (!Array.isArray(parsed.recipes)) {
        setToolsJsonState('–û–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ–ª–µ recipes: []');
        return;
      }
      toolsData = { version: 1, recipes: parsed.recipes };
      renderToolsList();
      setToolsJsonState('–ø—Ä–∏–º–µ–Ω–µ–Ω–æ (–Ω–µ –∑–∞–±—É–¥—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å)');
    } catch (e) {
      setToolsJsonState('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON');
    }
  }

  function setMapState(t) {
    if (mapState) mapState.textContent = t || '';
  }

  function keyXY(x, y) { return `${x},${y}`; }

  function waterSet() {
    const s = new Set();
    for (const c of (mapData.terrain && mapData.terrain.water) ? mapData.terrain.water : []) {
      try { s.add(keyXY(c[0], c[1])); } catch (e) {}
    }
    return s;
  }

  function objMap() {
    const m = new Map();
    for (const o of mapData.objects || []) {
      m.set(keyXY(o.x, o.y), o.type);
    }
    return m;
  }

  function setCell(x, y, brush) {
    const w = mapData.width || 100;
    const h = mapData.height || 100;
    if (x < 0 || y < 0 || x >= w || y >= h) return;
    const ws = waterSet();
    const om = objMap();
    const k = keyXY(x, y);

    if (brush === 'water') {
      ws.add(k);
      om.delete(k);
    } else if (brush === 'erase_water') {
      ws.delete(k);
    } else if (brush === 'erase_obj') {
      om.delete(k);
    } else {
      om.set(k, brush);
      ws.delete(k);
    }

    mapData.terrain = { water: Array.from(ws).map(s => s.split(',').map(n => parseInt(n, 10))) };
    mapData.objects = Array.from(om.entries()).map(([kk, t]) => {
      const [sx, sy] = kk.split(',').map(n => parseInt(n, 10));
      return { type: t, x: sx, y: sy, quantity: 1 };
    });
  }

  function drawMap() {
    if (!mapCtx || !mapCanvas) return;
    const w = mapData.width || 100;
    const h = mapData.height || 100;
    mapW.value = String(w);
    mapH.value = String(h);

    const cell = Math.max(4, Math.min(60, mapBaseCell * mapCam.zoom));
    const pad = 10;
    const cw = mapCanvas.width;
    const ch = mapCanvas.height;
    mapCtx.clearRect(0, 0, cw, ch);
    mapCtx.fillStyle = 'rgba(0,0,0,0.12)';
    mapCtx.fillRect(0, 0, cw, ch);

    const ws = waterSet();
    const om = objMap();


    // Camera: mapCam.x/y are pixel offsets of world origin inside canvas
    const originX = pad + mapCam.x;
    const originY = pad + mapCam.y;
    const startX = Math.max(0, Math.floor((-originX) / cell) - 1);
    const startY = Math.max(0, Math.floor((-originY) / cell) - 1);
    const endX = Math.min(w, Math.ceil((cw - originX) / cell) + 1);
    const endY = Math.min(h, Math.ceil((ch - originY) / cell) + 1);

    for (let y = startY; y < endY; y++) {
      for (let x = startX; x < endX; x++) {
        const px = originX + x * cell;
        const py = originY + y * cell;
        const k = keyXY(x, y);
        const isWater = ws.has(k);
        const obj = om.get(k) || null;

        if (isWater) {
          mapCtx.fillStyle = 'rgba(46, 107, 255, 0.60)';
          mapCtx.fillRect(px, py, cell, cell);
        } else {
          mapCtx.fillStyle = 'rgba(255,255,255,0.04)';
          mapCtx.fillRect(px, py, cell, cell);
        }

        if (obj) {
          const colors = {
            wood: 'rgba(180, 120, 60, 0.9)',
            stone: 'rgba(180, 180, 190, 0.9)',
            plant: 'rgba(36, 193, 106, 0.9)',
            berry: 'rgba(200, 80, 160, 0.9)',
            bone: 'rgba(220, 220, 200, 0.9)',
            fiber: 'rgba(240, 180, 41, 0.9)',
          };
          mapCtx.fillStyle = colors[obj] || 'rgba(255,255,255,0.8)';
          mapCtx.fillRect(px + 2, py + 2, cell - 4, cell - 4);
        }

        mapCtx.strokeStyle = 'rgba(255,255,255,0.06)';
        mapCtx.strokeRect(px, py, cell, cell);
      }
    }

    setMapState(`—Ä–∞–∑–º–µ—Ä: ${w}√ó${h} | –≤–æ–¥–∞: ${ws.size} | —Ä–µ—Å—É—Ä—Å–æ–≤: ${om.size}`);

    drawMiniMap(w, h, ws, om, { originX, originY, cell, cw, ch });
  }

  function drawMiniMap(w, h, ws, om, view) {
    if (!miniCtx || !mapMini) return;
    const mw = mapMini.width;
    const mh = mapMini.height;
    miniCtx.clearRect(0, 0, mw, mh);
    miniCtx.fillStyle = 'rgba(0,0,0,0.12)';
    miniCtx.fillRect(0, 0, mw, mh);

    const sx = mw / Math.max(1, w);
    const sy = mh / Math.max(1, h);

    // Water
    miniCtx.fillStyle = 'rgba(46, 107, 255, 0.55)';
    for (const kk of ws) {
      const parts = kk.split(',');
      const x = parseInt(parts[0], 10);
      const y = parseInt(parts[1], 10);
      miniCtx.fillRect(x * sx, y * sy, Math.max(1, sx), Math.max(1, sy));
    }

    // Objects
    for (const [kk, t] of om.entries()) {
      const parts = kk.split(',');
      const x = parseInt(parts[0], 10);
      const y = parseInt(parts[1], 10);
      const colors = {
        wood: 'rgba(180, 120, 60, 0.9)',
        stone: 'rgba(180, 180, 190, 0.9)',
        plant: 'rgba(36, 193, 106, 0.9)',
        berry: 'rgba(200, 80, 160, 0.9)',
        bone: 'rgba(220, 220, 200, 0.9)',
        fiber: 'rgba(240, 180, 41, 0.9)',
      };
      miniCtx.fillStyle = colors[t] || 'rgba(255,255,255,0.85)';
      miniCtx.fillRect(x * sx, y * sy, Math.max(1, sx), Math.max(1, sy));
    }

    // Viewport rectangle
    const vx0 = (-view.originX) / view.cell;
    const vy0 = (-view.originY) / view.cell;
    const vx1 = (view.cw - view.originX) / view.cell;
    const vy1 = (view.ch - view.originY) / view.cell;
    const rx = Math.max(0, vx0) * sx;
    const ry = Math.max(0, vy0) * sy;
    const rw = Math.max(0, Math.min(w, vx1) - Math.max(0, vx0)) * sx;
    const rh = Math.max(0, Math.min(h, vy1) - Math.max(0, vy0)) * sy;
    miniCtx.strokeStyle = 'rgba(255,255,255,0.85)';
    miniCtx.lineWidth = 2;
    miniCtx.strokeRect(rx + 1, ry + 1, Math.max(2, rw - 2), Math.max(2, rh - 2));
  }

  function canvasToCell(e) {
    const rect = mapCanvas.getBoundingClientRect();
    const xCss = e.clientX - rect.left;
    const yCss = e.clientY - rect.top;
    const scaleX = mapCanvas.width / rect.width;
    const scaleY = mapCanvas.height / rect.height;
    const x = xCss * scaleX;
    const y = yCss * scaleY;
    const cell = Math.max(4, Math.min(60, mapBaseCell * mapCam.zoom));
    const pad = 10;
    const originX = pad + mapCam.x;
    const originY = pad + mapCam.y;
    const cx = Math.floor((x - originX) / cell);
    const cy = Math.floor((y - originY) / cell);
    return { x: cx, y: cy };
  }

  function canvasToWorldPx(e) {
    const rect = mapCanvas.getBoundingClientRect();
    const xCss = e.clientX - rect.left;
    const yCss = e.clientY - rect.top;
    const scaleX = mapCanvas.width / rect.width;
    const scaleY = mapCanvas.height / rect.height;
    return { x: xCss * scaleX, y: yCss * scaleY };
  }

  async function loadMap() {
    const token = getToken();
    if (!token) return;
    setMapState('...');
    const { res, data } = await jsonFetch('/api/admin/map?token=' + encodeURIComponent(token), { cache: 'no-store' });
    if (!res.ok) {
      setMapState(localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }
    mapData = data.map || mapData;
    drawMap();
  }

  async function saveMap() {
    const token = getToken();
    if (!token) return;
    const w = parseInt(mapW.value || '0', 10);
    const h = parseInt(mapH.value || '0', 10);
    mapData.width = w;
    mapData.height = h;
    setMapState('...');
    const { res, data } = await jsonFetch('/api/admin/map?token=' + encodeURIComponent(token), {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(mapData)
    });
    if (!res.ok) {
      setMapState(localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }
    drawMap();
    setMapState('—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  }

  async function applyMapNow() {
    const token = getToken();
    if (!token) return;
    await saveMap();
    setMapState('–ø—Ä–∏–º–µ–Ω—è–µ–º (–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥–æ–Ω–∞)...');
    const { res, data } = await jsonFetch('/api/admin/map/apply?token=' + encodeURIComponent(token), { method: 'POST' });
    if (!res.ok) {
      setMapState(localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }
    setMapState('–ø—Ä–∏–º–µ–Ω–µ–Ω–æ');
  }

  async function jsonFetch(url, options) {
    const res = await fetch(url, options || {});
    const data = await res.json().catch(() => ({}));
    return { res, data };
  }

  async function refreshBootstrapStatus() {
    const { res, data } = await jsonFetch('/api/admin/bootstrap/status', { cache: 'no-store' });
    if (!res.ok) {
      setPill(globalState, 'warn', '–æ—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
      return;
    }
    const adminExists = !!data.admin_exists;
    const regOpen = !!data.registration_open;
    const msg = `admin_exists=${adminExists} | registration_open=${regOpen}`;
    setPill(globalState, adminExists ? 'ok' : 'warn', msg);
    btnBootstrap.disabled = !!data.admin_exists;
  }

  async function bootstrapAdmin() {
    setText(bootState, '...');
    const username = (bootUser.value || '').trim();
    const password = bootPass.value || '';
    const { res, data } = await jsonFetch('/api/admin/bootstrap', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    if (!res.ok) {
      setText(bootState, localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      await refreshBootstrapStatus();
      return;
    }
    setToken(data.token);
    localStorage.setItem('evosim_username', data.username);
    localStorage.setItem('evosim_is_admin', data.is_admin ? '1' : '0');
    setText(bootState, `–≥–æ—Ç–æ–≤–æ: ${data.username} (admin)`);
    await refreshBootstrapStatus();
    await refreshMe();
    await loadUsers();
    await loadNews();
    await loadMap();
    await loadTools();
    await loadSiteSettings();
    await loadPrivacy();
    await loadChatAnnouncement();
  }

  async function login() {
    setText(loginState, '...');
    const username = (loginUser.value || '').trim();
    const password = loginPass.value || '';
    const { res, data } = await jsonFetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    if (!res.ok) {
      setText(loginState, localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }
    setToken(data.token);
    localStorage.setItem('evosim_username', data.username);
    localStorage.setItem('evosim_is_admin', data.is_admin ? '1' : '0');
    setText(loginState, `–≤—ã –≤–æ—à–ª–∏ –∫–∞–∫ ${data.username} (admin=${data.is_admin})`);
    await refreshMe();
    if (data.is_admin) {
      await loadUsers();
      await loadNews();
      await loadMap();
      await loadTools();
      await loadSiteSettings();
      await loadPrivacy();
      await loadChatAnnouncement();
    } else {
      await loadNews();
    }
  }

  function logout() {
    clearToken();
    setText(loginState, '');
    usersList.innerHTML = '';
    newsList.innerHTML = '';
    refreshMe();
  }

  async function refreshMe() {
    const token = getToken();
    const loggedIn = !!token;

    btnLogout.style.display = loggedIn ? '' : 'none';
    btnLogin.style.display = loggedIn ? 'none' : '';

    if (!token) {
      setText(usersState, '–Ω—É–∂–µ–Ω admin token');
      setText(newsState, '–Ω—É–∂–µ–Ω admin token');
      btnCreateUser.disabled = true;
      btnPostNews.disabled = true;
      return;
    }

    const { res, data } = await jsonFetch('/api/auth/me?token=' + encodeURIComponent(token), { cache: 'no-store' });
    if (!res.ok) {
      setText(loginState, localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      btnCreateUser.disabled = true;
      btnPostNews.disabled = true;
      return;
    }

    if (!data.is_admin) {
      setText(loginState, `–≤—ã –≤–æ—à–ª–∏ –∫–∞–∫ ${data.username}, –Ω–æ –≤—ã –Ω–µ –∞–¥–º–∏–Ω`);
      btnCreateUser.disabled = true;
      btnPostNews.disabled = true;
      return;
    }

    setText(loginState, `–≤—ã –≤–æ—à–ª–∏ –∫–∞–∫ ${data.username} > –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä`);
    btnCreateUser.disabled = false;
    btnPostNews.disabled = false;
  }

  async function loadUsers() {
    const token = getToken();
    if (!token) return;

    setText(usersState, '...');
    const { res, data } = await jsonFetch('/api/admin/users?token=' + encodeURIComponent(token), { cache: 'no-store' });
    if (!res.ok) {
      setText(usersState, localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }

    const items = data.items || [];
    setText(usersState, `–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${items.length}`);
    usersList.innerHTML = '';

    for (const u of items) {
      const div = document.createElement('div');
      div.className = 'item';
      const created = (u.created_at || '').replace('T', ' ').slice(0, 19);
      div.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div>
            <b>${u.username}</b>
            <span class="muted">#${u.id}</span>
            ${u.is_admin ? '<span class="muted"> > –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>' : ''}
            <div class="muted">—Å–æ–∑–¥–∞–Ω: ${created}</div>
          </div>
          <div class="row">
            <button class="btn btn-secondary btn-xs" data-act="toggle">${u.is_admin ? '–°–Ω—è—Ç—å admin' : '–°–¥–µ–ª–∞—Ç—å admin'}</button>
            <button class="btn btn-danger btn-xs" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `;

      const btnToggle = div.querySelector('button[data-act="toggle"]');
      const btnDel = div.querySelector('button[data-act="delete"]');

      btnToggle.addEventListener('click', async () => {
        try {
          const makeAdmin = !u.is_admin;
          const { res: r, data: d } = await jsonFetch('/api/admin/users/' + u.id + '/set_admin?token=' + encodeURIComponent(token), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_admin: makeAdmin })
          });
          if (!r.ok) {
            setText(usersState, localizeDetail(d.detail) || `–û—à–∏–±–∫–∞ ${r.status}`);
            return;
          }
          await loadUsers();
        } catch (e) {}
      });

      btnDel.addEventListener('click', async () => {
        try {
          const { res: r, data: d } = await jsonFetch('/api/admin/users/' + u.id + '?token=' + encodeURIComponent(token), {
            method: 'DELETE'
          });
          if (!r.ok) {
            setText(usersState, localizeDetail(d.detail) || `–û—à–∏–±–∫–∞ ${r.status}`);
            return;
          }
          await loadUsers();
        } catch (e) {}
      });

      usersList.appendChild(div);
    }

    await loadUserAgents();
  }

  async function createUser() {
    const token = getToken();
    if (!token) return;

    setText(createUserState, '...');
    const username = (newUser.value || '').trim();
    const password = newPass.value || '';
    const is_admin = !!newIsAdmin.checked;

    const { res, data } = await jsonFetch('/api/admin/users?token=' + encodeURIComponent(token), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password, is_admin })
    });

    if (!res.ok) {
      setText(createUserState, localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }

    newUser.value = '';
    newPass.value = '';
    newIsAdmin.checked = false;
    setText(createUserState, '—Å–æ–∑–¥–∞–Ω–æ');
    await loadUsers();
  }

  function renderNews(items) {
    newsList.innerHTML = '';
    const arr = items || [];
    setText(newsState, `–Ω–æ–≤–æ—Å—Ç–µ–π: ${arr.length}`);

    for (let i = arr.length - 1; i >= 0; i--) {
      const n = arr[i];
      const div = document.createElement('div');
      div.className = 'item';
      const t = (n.created_at || '').replace('T', ' ').slice(0, 19);
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:12px;">
          <div style="flex:1;">
            <div><b>${n.title}</b></div>
            <div class="muted">${t} ‚Äî ${n.author_username} ‚Äî #${n.id}</div>
            <div style="white-space:pre-wrap; margin-top:6px;">${escapeHtml(n.text)}</div>
          </div>
          <div>
            <button class="btn btn-danger btn-xs" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
      `;
      div.querySelector('button[data-act="delete"]').addEventListener('click', async () => {
        const token = getToken();
        if (!token) return;
        const { res, data } = await jsonFetch('/api/admin/news/' + n.id + '?token=' + encodeURIComponent(token), { method: 'DELETE' });
        if (!res.ok) {
          setText(newsState, localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
          return;
        }
        await loadNews();
      });
      newsList.appendChild(div);
    }
  }

  function escapeHtml(s) {
    return String(s || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;');
  }

  async function loadNews() {
    setText(newsState, '...');
    const { res, data } = await jsonFetch('/api/news?limit=50', { cache: 'no-store' });
    if (!res.ok) {
      setText(newsState, localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }
    renderNews(data.items || []);
  }

  async function postNews() {
    const token = getToken();
    if (!token) return;

    setText(postNewsState, '...');
    const title = (newsTitle.value || '').trim();
    const text = (newsText.value || '').trim();

    const { res, data } = await jsonFetch('/api/admin/news?token=' + encodeURIComponent(token), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, text })
    });

    if (!res.ok) {
      setText(postNewsState, localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
      return;
    }

    newsTitle.value = '';
    newsText.value = '';
    setText(postNewsState, '–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ');
    await loadNews();
  }

  async function loadChatMessages() {
    const token = getToken();
    if (!token) return;
    setText(chatModState, '...');
    try {
      const { res, data } = await jsonFetch('/api/admin/chat/messages?token=' + encodeURIComponent(token), { cache: 'no-store' });
      if (!res.ok) throw new Error(localizeDetail(data && data.detail));
      const items = data.items || [];
      chatMessagesAdmin.innerHTML = '';
      for (const m of items) {
        const div = document.createElement('div');
        div.className = 'item';
        const created = (m.created_at || '').replace('T', ' ').slice(0, 19);
        div.innerHTML = `
          <div class="row" style="justify-content:space-between;">
            <div>
              <b>${m.username}</b>
              <span class="muted">#${m.id}</span>
              <div class="muted">—Å–æ–∑–¥–∞–Ω: ${created}</div>
            </div>
            <div class="row">
              <button class="btn btn-danger btn-xs" data-act="delete">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        `;
        div.querySelector('button[data-act="delete"]').addEventListener('click', async () => {
          const token = getToken();
          if (!token) return;
          const { res, data } = await jsonFetch('/api/admin/chat/messages/' + m.id + '?token=' + encodeURIComponent(token), { method: 'DELETE' });
          if (!res.ok) {
            setText(chatModState, localizeDetail(data.detail) || `–û—à–∏–±–∫–∞ ${res.status}`);
            return;
          }
          await loadChatMessages();
        });
        chatMessagesAdmin.appendChild(div);
      }
    } catch (e) {
      setText(chatModState, String(e && e.message ? e.message : e));
    }
  }

  async function applyChatBan() {
    const token = getToken();
    if (!token) return;
    setText(chatModState, '...');
    try {
      const uid = parseInt(chatBanUserId.value || '0', 10);
      const banned = chatBanMode.value === 'ban';
      const { res, data } = await jsonFetch('/api/admin/chat/ban?token=' + encodeURIComponent(token), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: uid, banned })
      });
      if (!res.ok) throw new Error(localizeDetail(data && data.detail));
      setText(chatModState, banned ? '–∑–∞–±–∞–Ω–µ–Ω' : '—Ä–∞–∑–±–∞–Ω–µ–Ω');
    } catch (e) {
      setText(chatModState, String(e && e.message ? e.message : e));
    }
  }

  btnBootstrap.addEventListener('click', () => { bootstrapAdmin(); });
  btnLogin.addEventListener('click', () => { login(); });
  btnLogout.addEventListener('click', () => { logout(); });

  btnReloadUsers.addEventListener('click', () => { loadUsers(); });
  btnCreateUser.addEventListener('click', () => { createUser(); });

  if (btnReloadUserAgents) btnReloadUserAgents.addEventListener('click', () => { loadUserAgents(); });

  btnReloadNews.addEventListener('click', () => { loadNews(); });
  btnPostNews.addEventListener('click', () => { postNews(); });

  if (tabUsers) {
    tabUsers.addEventListener('click', () => showTab('users'));
  }
  if (tabNews) {
    tabNews.addEventListener('click', () => showTab('news'));
  }
  if (tabMap) {
    tabMap.addEventListener('click', () => showTab('map'));
  }
  if (tabTools) {
    tabTools.addEventListener('click', () => showTab('tools'));
  }
  if (tabSite) {
    tabSite.addEventListener('click', () => showTab('site'));
  }
  if (tabPrivacy) {
    tabPrivacy.addEventListener('click', () => showTab('privacy'));
  }
  if (tabChat) {
    tabChat.addEventListener('click', () => showTab('chat'));
  }
  if (tabSprites) {
    tabSprites.addEventListener('click', () => showTab('sprites'));
  }
  if (tabAnimals) {
    tabAnimals.addEventListener('click', () => showTab('animals'));
  }

  if (btnSiteLoad) btnSiteLoad.addEventListener('click', () => loadSiteSettings());
  if (btnSiteSave) btnSiteSave.addEventListener('click', () => saveSiteSettings());

  if (btnPrivacyLoad) btnPrivacyLoad.addEventListener('click', () => loadPrivacy());
  if (btnPrivacySave) btnPrivacySave.addEventListener('click', () => savePrivacy());

  if (btnChatAnnLoad) btnChatAnnLoad.addEventListener('click', () => loadChatAnnouncement());
  if (btnChatAnnSave) btnChatAnnSave.addEventListener('click', () => saveChatAnnouncement());
  if (btnChatReload) btnChatReload.addEventListener('click', () => loadChatMessages());
  if (btnChatBan) btnChatBan.addEventListener('click', () => applyChatBan());

  if (btnMapLoad) btnMapLoad.addEventListener('click', () => loadMap());
  if (btnMapSave) btnMapSave.addEventListener('click', () => saveMap());
  if (btnMapApply) btnMapApply.addEventListener('click', () => applyMapNow());

  if (btnToolsReload) btnToolsReload.addEventListener('click', () => loadTools());
  if (btnToolsSave) btnToolsSave.addEventListener('click', () => saveTools());
  if (btnToolsAdd) btnToolsAdd.addEventListener('click', () => addToolRecipeFromForm());
  if (btnToolsExport) btnToolsExport.addEventListener('click', () => openToolsJsonBox('export'));
  if (btnToolsImport) btnToolsImport.addEventListener('click', () => openToolsJsonBox('import'));
  if (btnToolsJsonApply) btnToolsJsonApply.addEventListener('click', () => applyToolsJson());
  if (btnToolsJsonClose) btnToolsJsonClose.addEventListener('click', () => closeToolsJsonBox());

  if (mapCanvas) {
    mapCanvas.addEventListener('wheel', (e) => {
      e.preventDefault();
      const before = canvasToWorldPx(e);
      const old = mapCam.zoom;
      const step = e.deltaY < 0 ? 1.12 : 1 / 1.12;
      mapCam.zoom = Math.max(0.35, Math.min(4.0, mapCam.zoom * step));
      // keep cursor anchored
      const pad = 10;
      const cellOld = Math.max(4, Math.min(60, mapBaseCell * old));
      const cellNew = Math.max(4, Math.min(60, mapBaseCell * mapCam.zoom));
      const originOldX = pad + mapCam.x;
      const originOldY = pad + mapCam.y;
      const worldX = (before.x - originOldX) / cellOld;
      const worldY = (before.y - originOldY) / cellOld;
      const originNewX = before.x - worldX * cellNew;
      const originNewY = before.y - worldY * cellNew;
      mapCam.x = originNewX - pad;
      mapCam.y = originNewY - pad;
      drawMap();
    }, { passive: false });

    mapCanvas.addEventListener('contextmenu', (e) => e.preventDefault());

    mapCanvas.addEventListener('mousedown', (e) => {
      // Left = paint, Right/Middle = pan
      if (e.button === 1 || e.button === 2) {
        mapIsPan = true;
        panPrev = { x: e.clientX, y: e.clientY };
        return;
      }
      mapIsDown = true;
      const { x, y } = canvasToCell(e);
      setCell(x, y, mapBrush.value);
      drawMap();
    });
    window.addEventListener('mouseup', () => { mapIsDown = false; mapIsPan = false; panPrev = null; });
    mapCanvas.addEventListener('mousemove', (e) => {
      if (mapIsPan && panPrev) {
        const dx = e.clientX - panPrev.x;
        const dy = e.clientY - panPrev.y;
        panPrev = { x: e.clientX, y: e.clientY };
        mapCam.x += dx;
        mapCam.y += dy;
        drawMap();
        return;
      }
      if (!mapIsDown) return;
      const { x, y } = canvasToCell(e);
      setCell(x, y, mapBrush.value);
      drawMap();
    });
  }

  if (mapMini) {
    mapMini.addEventListener('click', (e) => {
      const w = mapData.width || 100;
      const h = mapData.height || 100;
      const rect = mapMini.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;
      const cell = Math.max(4, Math.min(60, mapBaseCell * mapCam.zoom));
      const pad = 10;
      const cw = mapCanvas.width;
      const ch = mapCanvas.height;
      const targetX = x * w;
      const targetY = y * h;
      mapCam.x = (cw / 2) - pad - targetX * cell;
      mapCam.y = (ch / 2) - pad - targetY * cell;
      drawMap();
    });
  }

  // ‚îÄ‚îÄ Sprites / Textures ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const spriteSlotsList = document.getElementById('spriteSlotsList');
  const spritesState = document.getElementById('spritesState');

  const spriteSlotNames = {
    ground: '–ó–µ–º–ª—è (–æ—Å–Ω–æ–≤–Ω–∞—è)',
    ground_forest: '–õ–µ—Å–Ω–æ–π –±–∏–æ–º',
    ground_desert: '–ü—É—Å—Ç—ã–Ω—è',
    ground_mountain: '–ì–æ—Ä—ã',
    ground_swamp: '–ë–æ–ª–æ—Ç–æ',
    ground_winter: '–ó–∏–º–∞ (—Å–Ω–µ–≥)',
    ground_winter_forest: '–ó–∏–º–Ω–∏–π –ª–µ—Å',
    ground_winter_desert: '–ó–∏–º–Ω—è—è –ø—É—Å—Ç—ã–Ω—è',
    water: '–í–æ–¥–∞',
  };

  async function loadSpriteSlots() {
    if (!spriteSlotsList) return;
    if (spritesState) spritesState.textContent = '...';
    try {
      const { res, data } = await jsonFetch('/api/sprites', { cache: 'no-store' });
      if (!res.ok) { if (spritesState) spritesState.textContent = '–û—à–∏–±–∫–∞'; return; }
      const slots = data.slots || [];
      const loaded = data.loaded || {};
      if (spritesState) spritesState.textContent = '';
      spriteSlotsList.innerHTML = '';
      for (const slot of slots) {
        const isLoaded = loaded[slot];
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:10px;">
              <span class="dot ${isLoaded ? 'ok' : ''}"></span>
              <div>
                <b>${escapeHtml(spriteSlotNames[slot] || slot)}</b>
                <div class="muted mono">${escapeHtml(slot)}.png ${isLoaded ? '‚úì –∑–∞–≥—Ä—É–∂–µ–Ω' : '‚Äî –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω'}</div>
              </div>
              ${isLoaded ? `<img src="/api/sprites/${slot}?_=${Date.now()}" style="height:40px; border-radius:4px; border:1px solid var(--border-subtle);" />` : ''}
            </div>
            <div class="row" style="gap:6px;">
              <input type="file" accept="image/png" style="max-width:160px; font-size:11px;" data-slot="${escapeHtml(slot)}" class="sprite-file-input" />
              <button class="btn btn-primary btn-xs sprite-upload-btn" data-slot="${escapeHtml(slot)}">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
              ${isLoaded ? `<button class="btn btn-danger btn-xs sprite-delete-btn" data-slot="${escapeHtml(slot)}">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
            </div>
          </div>
        `;
        spriteSlotsList.appendChild(div);
      }
      // Attach handlers
      spriteSlotsList.querySelectorAll('.sprite-upload-btn').forEach(btn => {
        btn.addEventListener('click', () => uploadSprite(btn.dataset.slot));
      });
      spriteSlotsList.querySelectorAll('.sprite-delete-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteSprite(btn.dataset.slot));
      });
    } catch (e) {
      if (spritesState) spritesState.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
    }
  }

  async function uploadSprite(slot) {
    const token = getToken();
    if (!token) return;
    const input = spriteSlotsList.querySelector(`.sprite-file-input[data-slot="${slot}"]`);
    if (!input || !input.files.length) { alert('–í—ã–±–µ—Ä–∏—Ç–µ PNG —Ñ–∞–π–ª'); return; }
    const file = input.files[0];
    if (!file.type.includes('png')) { alert('–¢–æ–ª—å–∫–æ PNG —Ñ–∞–π–ª—ã'); return; }
    if (file.size > 2 * 1024 * 1024) { alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 2 –ú–ë)'); return; }
    const fd = new FormData();
    fd.append('file', file);
    try {
      if (spritesState) spritesState.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
      const res = await fetch(`/api/admin/sprites/${slot}?token=${encodeURIComponent(token)}`, { method: 'POST', body: fd });
      const d = await res.json().catch(() => ({}));
      if (!res.ok) { alert(localizeDetail(d.detail) || '–û—à–∏–±–∫–∞'); }
      await loadSpriteSlots();
    } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  }

  async function deleteSprite(slot) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—Å—Ç—É—Ä—É "${spriteSlotNames[slot] || slot}"?`)) return;
    const token = getToken();
    if (!token) return;
    try {
      await fetch(`/api/admin/sprites/${slot}?token=${encodeURIComponent(token)}`, { method: 'DELETE' });
      await loadSpriteSlots();
    } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  }

  // ‚îÄ‚îÄ Animals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const animalsList = document.getElementById('animalsList');
  const animalsState = document.getElementById('animalsState');
  const animalCreateState = document.getElementById('animalCreateState');
  const btnAnimalCreate = document.getElementById('btnAnimalCreate');
  const btnAnimalsReload = document.getElementById('btnAnimalsReload');

  const statusRu = { active: '–ê–∫—Ç–∏–≤–Ω–æ', passive: '–ü–∞—Å—Å–∏–≤–Ω–æ–µ', hostile: '–í—Ä–∞–∂–¥–µ–±–Ω–æ–µ', friendly: '–î—Ä—É–∂–µ–ª—é–±–Ω–æ–µ', disabled: '–û—Ç–∫–ª—é—á–µ–Ω–æ' };
  const dirRu = { up: '–í–≤–µ—Ä—Ö', down: '–í–Ω–∏–∑', left: '–í–ª–µ–≤–æ', right: '–í–ø—Ä–∞–≤–æ' };

  async function loadAnimals() {
    if (!animalsList) return;
    if (animalsState) animalsState.textContent = '...';
    try {
      const { res, data } = await jsonFetch('/api/animals', { cache: 'no-store' });
      if (!res.ok) { if (animalsState) animalsState.textContent = '–û—à–∏–±–∫–∞'; return; }
      const animals = data.animals || [];
      if (animalsState) animalsState.textContent = `${animals.length} —à—Ç.`;
      animalsList.innerHTML = '';
      if (!animals.length) {
        animalsList.innerHTML = '<div class="muted">–ù–µ—Ç –∂–∏–≤–æ—Ç–Ω—ã—Ö. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –≤—ã—à–µ.</div>';
        return;
      }
      for (const a of animals) {
        const card = renderAnimalCard(a);
        animalsList.appendChild(card);
      }
    } catch (e) {
      if (animalsState) animalsState.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
    }
  }

  function renderAnimalCard(a) {
    const div = document.createElement('div');
    div.className = 'item';
    const sp = a.sprites || {};
    let spritesHtml = '<div class="row" style="gap:6px; margin-top:8px; flex-wrap:wrap;">';
    for (const dir of ['up', 'down', 'left', 'right']) {
      const hasSprite = sp[dir];
      spritesHtml += `
        <div style="text-align:center; border:1px solid var(--border-subtle); border-radius:6px; padding:4px; min-width:70px;">
          <div class="muted" style="font-size:10px; margin-bottom:2px;">${dirRu[dir]}</div>
          ${hasSprite
            ? `<img src="/api/animals/${a.id}/sprite/${dir}?_=${Date.now()}" style="height:48px; display:block; margin:0 auto 4px;" />`
            : `<div style="height:48px; display:flex; align-items:center; justify-content:center; color:var(--text-muted); font-size:20px;">?</div>`
          }
          <input type="file" accept="image/png" style="font-size:10px; max-width:80px;" class="animal-sprite-input" data-aid="${a.id}" data-dir="${dir}" />
          <button class="btn btn-primary btn-xs animal-sprite-upload" data-aid="${a.id}" data-dir="${dir}" style="margin-top:2px; font-size:10px;">‚Üë</button>
        </div>
      `;
    }
    spritesHtml += '</div>';

    div.innerHTML = `
      <div class="row" style="justify-content:space-between; align-items:flex-start;">
        <div style="flex:1;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <b style="font-size:14px;">${escapeHtml(a.name)}</b>
            <span class="pill"><span class="dot ${a.status === 'disabled' ? 'warn' : 'ok'}"></span>${escapeHtml(statusRu[a.status] || a.status)}</span>
          </div>
          ${a.description ? `<div class="muted" style="margin-bottom:4px;">${escapeHtml(a.description)}</div>` : ''}
          <div class="muted mono" style="font-size:11px;">
            HP=${a.health} ¬∑ –£—Ä–æ–Ω=${a.damage} ¬∑ –ë—Ä–æ–Ω—è=${a.armor} ¬∑ –°–∫–æ—Ä–æ—Å—Ç—å=${a.speed} ¬∑ –ê–≥—Ä–µ—Å—Å–∏—è=${a.aggression}
          </div>
          <div class="muted" style="font-size:10px;">ID: ${escapeHtml(a.id)}</div>
          ${spritesHtml}
        </div>
        <div style="display:flex; flex-direction:column; gap:4px; margin-left:10px;">
          <button class="btn btn-danger btn-xs animal-delete-btn" data-aid="${a.id}">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
    `;

    // Attach handlers after appending
    setTimeout(() => {
      div.querySelectorAll('.animal-sprite-upload').forEach(btn => {
        btn.addEventListener('click', () => uploadAnimalSprite(btn.dataset.aid, btn.dataset.dir));
      });
      div.querySelector('.animal-delete-btn')?.addEventListener('click', () => deleteAnimal(a.id, a.name));
    }, 0);

    return div;
  }

  async function createAnimal() {
    const token = getToken();
    if (!token) { if (animalCreateState) animalCreateState.textContent = '–í–æ–π–¥–∏—Ç–µ'; return; }
    const name = (document.getElementById('animalName')?.value || '').trim();
    if (!name) { if (animalCreateState) animalCreateState.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'; return; }
    const payload = {
      name,
      status: document.getElementById('animalStatus')?.value || 'active',
      health: parseInt(document.getElementById('animalHealth')?.value || '100'),
      speed: parseFloat(document.getElementById('animalSpeed')?.value || '1.0'),
      damage: parseInt(document.getElementById('animalDamage')?.value || '10'),
      armor: parseInt(document.getElementById('animalArmor')?.value || '0'),
      aggression: parseFloat(document.getElementById('animalAggression')?.value || '0.5'),
      description: (document.getElementById('animalDesc')?.value || '').trim(),
    };
    if (animalCreateState) animalCreateState.textContent = '...';
    try {
      const { res, data } = await jsonFetch(`/api/admin/animals?token=${encodeURIComponent(token)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        if (animalCreateState) animalCreateState.textContent = localizeDetail(data.detail) || '–û—à–∏–±–∫–∞';
        return;
      }
      if (animalCreateState) animalCreateState.textContent = '–°–æ–∑–¥–∞–Ω–æ!';
      document.getElementById('animalName').value = '';
      document.getElementById('animalDesc').value = '';
      await loadAnimals();
    } catch (e) {
      if (animalCreateState) animalCreateState.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
    }
  }

  async function deleteAnimal(aid, name) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∂–∏–≤–æ—Ç–Ω–æ–µ "${name}"?`)) return;
    const token = getToken();
    if (!token) return;
    try {
      await fetch(`/api/admin/animals/${aid}?token=${encodeURIComponent(token)}`, { method: 'DELETE' });
      await loadAnimals();
    } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  }

  async function uploadAnimalSprite(aid, dir) {
    const token = getToken();
    if (!token) return;
    const input = document.querySelector(`.animal-sprite-input[data-aid="${aid}"][data-dir="${dir}"]`);
    if (!input || !input.files.length) { alert('–í—ã–±–µ—Ä–∏—Ç–µ PNG —Ñ–∞–π–ª'); return; }
    const file = input.files[0];
    if (!file.type.includes('png')) { alert('–¢–æ–ª—å–∫–æ PNG —Ñ–∞–π–ª—ã'); return; }
    if (file.size > 2 * 1024 * 1024) { alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 2 –ú–ë)'); return; }
    const fd = new FormData();
    fd.append('file', file);
    try {
      const res = await fetch(`/api/admin/animals/${aid}/sprite/${dir}?token=${encodeURIComponent(token)}`, { method: 'POST', body: fd });
      const d = await res.json().catch(() => ({}));
      if (!res.ok) { alert(localizeDetail(d.detail) || '–û—à–∏–±–∫–∞'); return; }
      await loadAnimals();
    } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
  }

  if (btnAnimalCreate) btnAnimalCreate.addEventListener('click', () => createAnimal());
  if (btnAnimalsReload) btnAnimalsReload.addEventListener('click', () => loadAnimals());

  // Auto-fill saved username
  try {
    const savedUser = localStorage.getItem('evosim_username');
    if (savedUser && loginUser) loginUser.value = savedUser;
  } catch(e) {}

  (async () => {
    showTab('users');
    await refreshBootstrapStatus();
    await refreshMe();
    // Only load admin-only tabs if we have a valid admin token
    const token = getToken();
    if (token && localStorage.getItem('evosim_is_admin') === '1') {
      await loadUsers();
      await loadNews();
      await loadMap();
      await loadTools();
      await loadSiteSettings();
      await loadPrivacy();
      await loadChatAnnouncement();
    } else {
      await loadNews();
    }
  })();
</script>
</body>
</html>
